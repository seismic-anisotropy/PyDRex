<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 13.1.0"/>
    <title>pydrex.minerals</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */@media (prefers-color-scheme:light){  pre{line-height:125%;}  span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}  .pdoc-code .hll{background-color:#ffffcc}  .pdoc-code{background:#f8f8f8;}  .pdoc-code .c{color:#3D7B7B; font-style:italic}  .pdoc-code .err{border:1px solid #FF0000}  .pdoc-code .k{color:#008000; font-weight:bold}  .pdoc-code .o{color:#666666}  .pdoc-code .ch{color:#3D7B7B; font-style:italic}  .pdoc-code .cm{color:#3D7B7B; font-style:italic}  .pdoc-code .cp{color:#9C6500}  .pdoc-code .cpf{color:#3D7B7B; font-style:italic}  .pdoc-code .c1{color:#3D7B7B; font-style:italic}  .pdoc-code .cs{color:#3D7B7B; font-style:italic}  .pdoc-code .gd{color:#A00000}  .pdoc-code .ge{font-style:italic}  .pdoc-code .gr{color:#E40000}  .pdoc-code .gh{color:#000080; font-weight:bold}  .pdoc-code .gi{color:#008400}  .pdoc-code .go{color:#717171}  .pdoc-code .gp{color:#000080; font-weight:bold}  .pdoc-code .gs{font-weight:bold}  .pdoc-code .gu{color:#800080; font-weight:bold}  .pdoc-code .gt{color:#0044DD}  .pdoc-code .kc{color:#008000; font-weight:bold}  .pdoc-code .kd{color:#008000; font-weight:bold}  .pdoc-code .kn{color:#008000; font-weight:bold}  .pdoc-code .kp{color:#008000}  .pdoc-code .kr{color:#008000; font-weight:bold}  .pdoc-code .kt{color:#B00040}  .pdoc-code .m{color:#666666}  .pdoc-code .s{color:#BA2121}  .pdoc-code .na{color:#687822}  .pdoc-code .nb{color:#008000}  .pdoc-code .nc{color:#0000FF; font-weight:bold}  .pdoc-code .no{color:#880000}  .pdoc-code .nd{color:#AA22FF}  .pdoc-code .ni{color:#717171; font-weight:bold}  .pdoc-code .ne{color:#CB3F38; font-weight:bold}  .pdoc-code .nf{color:#0000FF}  .pdoc-code .nl{color:#767600}  .pdoc-code .nn{color:#0000FF; font-weight:bold}  .pdoc-code .nt{color:#008000; font-weight:bold}  .pdoc-code .nv{color:#19177C}  .pdoc-code .ow{color:#AA22FF; font-weight:bold}  .pdoc-code .w{color:#bbbbbb}  .pdoc-code .mb{color:#666666}  .pdoc-code .mf{color:#666666}  .pdoc-code .mh{color:#666666}  .pdoc-code .mi{color:#666666}  .pdoc-code .mo{color:#666666}  .pdoc-code .sa{color:#BA2121}  .pdoc-code .sb{color:#BA2121}  .pdoc-code .sc{color:#BA2121}  .pdoc-code .dl{color:#BA2121}  .pdoc-code .sd{color:#BA2121; font-style:italic}  .pdoc-code .s2{color:#BA2121}  .pdoc-code .se{color:#AA5D1F; font-weight:bold}  .pdoc-code .sh{color:#BA2121}  .pdoc-code .si{color:#A45A77; font-weight:bold}  .pdoc-code .sx{color:#008000}  .pdoc-code .sr{color:#A45A77}  .pdoc-code .s1{color:#BA2121}  .pdoc-code .ss{color:#19177C}  .pdoc-code .bp{color:#008000}  .pdoc-code .fm{color:#0000FF}  .pdoc-code .vc{color:#19177C}  .pdoc-code .vg{color:#19177C}  .pdoc-code .vi{color:#19177C}  .pdoc-code .vm{color:#19177C}  .pdoc-code .il{color:#666666}}@media (prefers-color-scheme:dark){  pre{line-height:125%;}  span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}  .pdoc-code .hll{background-color:#49483e}  .pdoc-code{background:#272822; color:#f8f8f2}  .pdoc-code .c{color:#75715e}  .pdoc-code .err{color:#960050; background-color:#1e0010}  .pdoc-code .esc{color:#f8f8f2}  .pdoc-code .g{color:#f8f8f2}  .pdoc-code .k{color:#66d9ef}  .pdoc-code .l{color:#ae81ff}  .pdoc-code .n{color:#f8f8f2}  .pdoc-code .o{color:#f92672}  .pdoc-code .x{color:#f8f8f2}  .pdoc-code .p{color:#f8f8f2}  .pdoc-code .ch{color:#75715e}  .pdoc-code .cm{color:#75715e}  .pdoc-code .cp{color:#75715e}  .pdoc-code .cpf{color:#75715e}  .pdoc-code .c1{color:#75715e}  .pdoc-code .cs{color:#75715e}  .pdoc-code .gd{color:#f92672}  .pdoc-code .ge{color:#f8f8f2; font-style:italic}  .pdoc-code .gr{color:#f8f8f2}  .pdoc-code .gh{color:#f8f8f2}  .pdoc-code .gi{color:#a6e22e}  .pdoc-code .go{color:#66d9ef}  .pdoc-code .gp{color:#f92672; font-weight:bold}  .pdoc-code .gs{color:#f8f8f2; font-weight:bold}  .pdoc-code .gu{color:#75715e}  .pdoc-code .gt{color:#f8f8f2}  .pdoc-code .kc{color:#66d9ef}  .pdoc-code .kd{color:#66d9ef}  .pdoc-code .kn{color:#f92672}  .pdoc-code .kp{color:#66d9ef}  .pdoc-code .kr{color:#66d9ef}  .pdoc-code .kt{color:#66d9ef}  .pdoc-code .ld{color:#e6db74}  .pdoc-code .m{color:#ae81ff}  .pdoc-code .s{color:#e6db74}  .pdoc-code .na{color:#a6e22e}  .pdoc-code .nb{color:#f8f8f2}  .pdoc-code .nc{color:#a6e22e}  .pdoc-code .no{color:#66d9ef}  .pdoc-code .nd{color:#a6e22e}  .pdoc-code .ni{color:#f8f8f2}  .pdoc-code .ne{color:#a6e22e}  .pdoc-code .nf{color:#a6e22e}  .pdoc-code .nl{color:#f8f8f2}  .pdoc-code .nn{color:#f8f8f2}  .pdoc-code .nx{color:#a6e22e}  .pdoc-code .py{color:#f8f8f2}  .pdoc-code .nt{color:#f92672}  .pdoc-code .nv{color:#f8f8f2}  .pdoc-code .ow{color:#f92672}  .pdoc-code .w{color:#f8f8f2}  .pdoc-code .mb{color:#ae81ff}  .pdoc-code .mf{color:#ae81ff}  .pdoc-code .mh{color:#ae81ff}  .pdoc-code .mi{color:#ae81ff}  .pdoc-code .mo{color:#ae81ff}  .pdoc-code .sa{color:#e6db74}  .pdoc-code .sb{color:#e6db74}  .pdoc-code .sc{color:#e6db74}  .pdoc-code .dl{color:#e6db74}  .pdoc-code .sd{color:#e6db74}  .pdoc-code .s2{color:#e6db74}  .pdoc-code .se{color:#ae81ff}  .pdoc-code .sh{color:#e6db74}  .pdoc-code .si{color:#e6db74}  .pdoc-code .sx{color:#e6db74}  .pdoc-code .sr{color:#e6db74}  .pdoc-code .s1{color:#e6db74}  .pdoc-code .ss{color:#e6db74}  .pdoc-code .bp{color:#f8f8f2}  .pdoc-code .fm{color:#a6e22e}  .pdoc-code .vc{color:#f8f8f2}  .pdoc-code .vg{color:#f8f8f2}  .pdoc-code .vi{color:#f8f8f2}  .pdoc-code .vm{color:#f8f8f2}}</style>
    <style>/*! theme.css */@media (prefers-color-scheme:light){  :root{  --pdoc-background:#fff; }  .pdoc{  --text:#212529;  --muted:#6c757d;  --link:#3660a5;  --link-hover:#1659c5;  --code:#f8f8f8;  --active:#fff598;  --accent:#eee;  --accent2:#c1c1c1;  --nav-hover:rgba(255, 255, 255, 0.5);  --name:#0066BB;  --def:#008800;  --annotation:#007020; }}@media (prefers-color-scheme:dark){  :root{  --pdoc-background:#212529; }  .pdoc{  --text:#f7f7f7;  --muted:#9d9d9d;  --link:#58a6ff;  --link-hover:#3989ff;  --code:#333;  --active:#555;  --accent:#343434;  --accent2:#555;  --nav-hover:rgba(0, 0, 0, 0.1);  --name:#77C1FF;  --def:#0cdd0c;  --annotation:#00c037; }}.homediv{padding-top:56px; max-width:1080px;}.button{background-color:var(--muted);color:var(--pdoc-background);border:none;padding:16px 32px;text-align:center;text-decoration:none;display:inline-block;font-weight:bold;font-size:20px;margin:4px 2px;transition-duration:0.4s;cursor:pointer;width:48%;}.button:hover{background-color:var(--text);color:var(--active);}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css" integrity="sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js" integrity="sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
            delimiters: [
                {left: '$$', right: '$$', display: true},
                {left: '\\[', right: '\\]', display: true},
                {left: '$', right: '$', display: false},
                {left: '\\(', right: '\\)', display: false},
                {left: '\\begin{equation}', right: '\\end{equation}', display: true},
                {left: '\\begin{equation\*}', right: '\\end{equation\*}', display: true},
                {left: '\\begin{align}', right: '\\end{align}', display: true},
                {left: '\\begin{align\*}', right: '\\end{align\*}', display: true},
            ],
            throwOnError: false
        });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/copy-tex.min.js" integrity="sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A" crossorigin="anonymous"></script></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../pydrex.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pydrex</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#OlivineFabric">OlivineFabric</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#OlivineFabric.A">A</a>
                        </li>
                        <li>
                                <a class="variable" href="#OlivineFabric.B">B</a>
                        </li>
                        <li>
                                <a class="variable" href="#OlivineFabric.C">C</a>
                        </li>
                        <li>
                                <a class="variable" href="#OlivineFabric.D">D</a>
                        </li>
                        <li>
                                <a class="variable" href="#OlivineFabric.E">E</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EnstatiteFabric">EnstatiteFabric</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#EnstatiteFabric.A">A</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#MineralPhase">MineralPhase</a>
                            <ul class="memberlist">
                        <li>
                                <a class="variable" href="#MineralPhase.olivine">olivine</a>
                        </li>
                        <li>
                                <a class="variable" href="#MineralPhase.enstatite">enstatite</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#get_crss">get_crss</a>
            </li>
            <li>
                    <a class="function" href="#get_primary_axis">get_primary_axis</a>
            </li>
            <li>
                    <a class="class" href="#Mineral">Mineral</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Mineral.__init__">Mineral</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mineral.phase">phase</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mineral.fabric">fabric</a>
                        </li>
                        <li>
                                <a class="variable" href="#Mineral.regime">regime</a>
                        </li>
                        <li>
                                <a class="function" href="#Mineral.update_orientations">update_orientations</a>
                        </li>
                        <li>
                                <a class="function" href="#Mineral.save">save</a>
                        </li>
                        <li>
                                <a class="function" href="#Mineral.load">load</a>
                        </li>
                        <li>
                                <a class="function" href="#Mineral.from_file">from_file</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../pydrex.html">pydrex</a><wbr>.minerals    </h1>

                        <div class="docstring"><blockquote>
  <p>PyDRex: Lagrangian data structures and mineral fabric definitions.</p>
</blockquote>

<p><strong>Acronyms:</strong></p>

<ul>
<li>CRSS = Critical Resolved Shear Stress,
i.e. threshold stress required to initiate slip on a slip system,
normalised to the stress required to initiate slip on the softest slip system</li>
</ul>
</div>

                        <input id="mod-minerals-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-minerals-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;&gt; PyDRex: Lagrangian data structures and mineral fabric definitions.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">**Acronyms:**</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="sd">- CRSS = Critical Resolved Shear Stress,</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">    i.e. threshold stress required to initiate slip on a slip system,</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">    normalised to the stress required to initiate slip on the softest slip system</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">import</span> <span class="nn">io</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">IntEnum</span><span class="p">,</span> <span class="n">unique</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">linalg</span> <span class="k">as</span> <span class="n">la</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">RK45</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a><span class="kn">from</span> <span class="nn">scipy.spatial.transform</span> <span class="kn">import</span> <span class="n">Rotation</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span> <span class="nn">pydrex</span> <span class="kn">import</span> <span class="n">core</span> <span class="k">as</span> <span class="n">_core</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a><span class="kn">from</span> <span class="nn">pydrex</span> <span class="kn">import</span> <span class="n">deformation_mechanism</span> <span class="k">as</span> <span class="n">_defmech</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="kn">from</span> <span class="nn">pydrex</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">_err</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="kn">from</span> <span class="nn">pydrex</span> <span class="kn">import</span> <span class="n">io</span> <span class="k">as</span> <span class="n">_io</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="kn">from</span> <span class="nn">pydrex</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">_log</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="nd">@unique</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="k">class</span> <span class="nc">OlivineFabric</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration type for olivine fabrics A-E.&quot;&quot;&quot;</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>    <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>    <span class="n">D</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>    <span class="n">E</span> <span class="o">=</span> <span class="mi">4</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="nd">@unique</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="k">class</span> <span class="nc">EnstatiteFabric</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration type with a single member A which is the only enstatite fabric.&quot;&quot;&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Just to make it consistent.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="nd">@unique</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a><span class="k">class</span> <span class="nc">MineralPhase</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Supported mineral phases:</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a><span class="sd">    - olivine (0)</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">    - enstatite (1)</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>    <span class="n">olivine</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>    <span class="n">enstatite</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="k">def</span> <span class="nf">get_crss</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">):</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get Critical Resolved Shear Stress for the mineral `phase` and `fabric`.</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a><span class="sd">    Returns an array of the normalised threshold stresses required to activate slip</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">    on each slip system.</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>    <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">olivine</span><span class="p">:</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="k">match</span> <span class="n">fabric</span><span class="p">:</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">B</span><span class="p">:</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">D</span><span class="p">:</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">E</span><span class="p">:</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fabric must be a valid `OlivineFabric`&quot;</span><span class="p">)</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>    <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">enstatite</span><span class="p">:</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>        <span class="k">if</span> <span class="n">fabric</span> <span class="o">==</span> <span class="n">EnstatiteFabric</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fabric must be a valid `EnstatiteFabric`&quot;</span><span class="p">)</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;phase must be a valid `MineralPhase`&quot;</span><span class="p">)</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="k">def</span> <span class="nf">get_primary_axis</span><span class="p">(</span><span class="n">fabric</span><span class="p">):</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get primary slip axis name for the given olivine `fabric`.&quot;&quot;&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="k">match</span> <span class="n">fabric</span><span class="p">:</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>            <span class="k">return</span> <span class="s2">&quot;a&quot;</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">B</span><span class="p">:</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>            <span class="k">return</span> <span class="s2">&quot;c&quot;</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a>            <span class="k">return</span> <span class="s2">&quot;c&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">D</span><span class="p">:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>            <span class="k">return</span> <span class="s2">&quot;a&quot;</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">E</span><span class="p">:</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>            <span class="k">return</span> <span class="s2">&quot;a&quot;</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fabric must be a valid `OlivineFabric`, not </span><span class="si">{</span><span class="n">fabric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a><span class="nd">@dataclass</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="k">class</span> <span class="nc">Mineral</span><span class="p">:</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for storing mineral CPO.</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a><span class="sd">    A `Mineral` stores CPO data for an aggregate of grains*.</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a><span class="sd">    Additionally, mineral fabric type and deformation regime</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a><span class="sd">    are also tracked. See `pydrex.deformation_mechanism`.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a><span class="sd">    Attributes:</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a><span class="sd">    - `phase` (int)  ordinal number of the mineral phase, see `MineralPhase`</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a><span class="sd">    - `fabric` (int)  ordinal number of the fabric type, see `OlivineFabric`</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a><span class="sd">      and `EnstatiteFabric`</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a><span class="sd">    - `regime` (int)  ordinal number of the deformation regime,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a><span class="sd">      see `pydrex.deformation_mechanism.Regime`</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="sd">    - `n_grains` (int)  number of grains in the aggregate</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a><span class="sd">    - `fractions_init` (array, optional)  initial dimensionless grain volumes</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a><span class="sd">    - `orientations_init` (array, optional)  initial grain orientation matrices</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a><span class="sd">    By default, a uniform volume distribution of random orientations is generated.</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="sd">    *Note that &quot;grains&quot; is here an approximate term,</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="sd">    and the stored objects do not fully correspond to physical grains.</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">    For example, the number of grains is fixed despite inclusion of</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">    grain nucleation in the modelling. It is assumed that new grains</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a><span class="sd">    do not grow large enough to require independent rotation tracking.</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a><span class="sd">    The DRex model is also unsuitable if static recrystallization is significant.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a>    <span class="n">phase</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">olivine</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a>    <span class="n">fabric</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">A</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a>    <span class="n">regime</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_defmech</span><span class="o">.</span><span class="n">Regime</span><span class="o">.</span><span class="n">dislocation</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>    <span class="n">n_grains</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>    <span class="c1"># Initial condition, randomised if not given.</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>    <span class="n">fractions_init</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>    <span class="n">orientations_init</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>    <span class="n">fractions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>    <span class="n">orientations</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>        <span class="c1"># String output, used for str(self) and f&quot;{self}&quot;, etc.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>            <span class="n">shape_of_fractions</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>            <span class="n">shape_of_fractions</span> <span class="o">=</span> <span class="s2">&quot;(?)&quot;</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>            <span class="n">shape_of_orientations</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a>            <span class="n">shape_of_orientations</span> <span class="o">=</span> <span class="s2">&quot;(?)&quot;</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;(phase=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fabric=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;regime=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regime</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;n_grains=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fractions=&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shape_of_fractions</span><span class="si">}</span><span class="s2">&gt;, &quot;</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;orientations=&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shape_of_orientations</span><span class="si">}</span><span class="s2">&gt;)&quot;</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a>        <span class="p">)</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>        <span class="c1"># Format to use when printing to IPython or other interactive console.</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cycle</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">+</span> <span class="s2">&quot;(...)&quot;</span><span class="p">)</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise random orientations and grain volume fractions.&quot;&quot;&quot;</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">)</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a>        <span class="c1"># Copy the initial values to the storage lists.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span><span class="p">)</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span><span class="p">)</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a>        <span class="c1"># Delete the initial value duplicates to avoid confusion.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;created </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">update_orientations</span><span class="p">(</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>        <span class="n">config</span><span class="p">,</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a>        <span class="n">velocity_gradient</span><span class="p">,</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a>        <span class="n">integration_time</span><span class="p">,</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>        <span class="n">pathline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a>    <span class="p">):</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update orientations and volume distribution for the `Mineral`.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        Update crystalline orientations and grain volume distribution</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">        for minerals undergoing plastic deformation.</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a><span class="sd">        Args:</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="sd">        - `config` (dict)  PyDRex configuration dictionary</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        - `deformation_gradient` (array)  3x3 initial deformation gradient tensor</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a><span class="sd">        - `velocity_gradient` (array or function)  3x3 velocity gradient matrix,</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">          or an interpolator that returns the 3x3 matrix when evaluated at a point</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">          along the provided pathline</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        - `integration_time` (float)  total time of integrated dislocation</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a><span class="sd">          creep (if `pathline` is not None, this is used as the maximum</span>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a><span class="sd">          integration timestep during CPO calculation)</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a><span class="sd">        - `pathline` (tuple, optional)  tuple consisting of:</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a><span class="sd">            1. the time at which to start the CPO integration</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a><span class="sd">            2. the time at which to stop the CPO integration</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a><span class="sd">            3. a callable that accepts a time value and returns the position of</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a><span class="sd">               the mineral</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a><span class="sd">        Array values must provide a NumPy-compatible interface:</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a><span class="sd">        &lt;https://numpy.org/doc/stable/user/whatisnumpy.html&gt;</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="c1"># Set up callables for the ODE, some variables come from enclosing scope.</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="k">def</span> <span class="nf">extract_vars</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>            <span class="c1"># TODO: Check if we can avoid .copy() here.</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a>            <span class="n">deformation_gradient</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>                <span class="n">y</span><span class="p">[</span><span class="mi">9</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a>                <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a>                <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>                <span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a>            <span class="p">)</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a>                <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>            <span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>            <span class="c1"># FIXME: Guard against zero-division? Why is .sum  0?</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>            <span class="n">fractions</span> <span class="o">/=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>            <span class="k">return</span> <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>        <span class="k">def</span> <span class="nf">eval_rhs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate right hand side of the D-Rex PDE.&quot;&quot;&quot;</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>            <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>            <span class="c1"># Uses nondimensional values of strain rate and velocity gradient.</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>            <span class="n">orientations_diff</span><span class="p">,</span> <span class="n">fractions_diff</span> <span class="o">=</span> <span class="n">_core</span><span class="o">.</span><span class="n">derivatives</span><span class="p">(</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>                <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>                <span class="n">fabric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="p">,</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>                <span class="n">n_grains</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>                <span class="n">orientations</span><span class="o">=</span><span class="n">orientations</span><span class="p">,</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>                <span class="n">fractions</span><span class="o">=</span><span class="n">fractions</span><span class="p">,</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>                <span class="n">strain_rate</span><span class="o">=</span><span class="n">strain_rate</span> <span class="o">/</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>                <span class="n">velocity_gradient</span><span class="o">=</span><span class="n">_velocity_gradient</span> <span class="o">/</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>                <span class="n">stress_exponent</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;stress_exponent&quot;</span><span class="p">],</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>                <span class="n">deformation_exponent</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;deformation_exponent&quot;</span><span class="p">],</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>                <span class="n">nucleation_efficiency</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nucleation_efficiency&quot;</span><span class="p">],</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>                <span class="n">gbm_mobility</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbm_mobility&quot;</span><span class="p">],</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>                <span class="n">volume_fraction</span><span class="o">=</span><span class="n">volume_fraction</span><span class="p">,</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>            <span class="p">)</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>                <span class="p">(</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>                    <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">@</span> <span class="n">deformation_gradient</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>                    <span class="n">orientations_diff</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>                    <span class="n">fractions_diff</span> <span class="o">*</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>                <span class="p">)</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a>            <span class="p">)</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a>        <span class="k">def</span> <span class="nf">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a>            <span class="c1"># Grain boundary sliding for small grains.</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">fractions</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbs_threshold&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a>                <span class="s2">&quot;grain boundary sliding activity (volume percentage): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>            <span class="p">)</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a>            <span class="c1"># No rotation: carry over previous orientations.</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a>            <span class="n">orientations</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a>            <span class="n">fractions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbs_threshold&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>            <span class="c1"># FIXME: Guard against zero-division? Why is .sum  0?</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>            <span class="n">fractions</span> <span class="o">/=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>                <span class="s2">&quot;grain volume fractions: median=</span><span class="si">%e</span><span class="s2">, min=</span><span class="si">%e</span><span class="s2">, max=</span><span class="si">%e</span><span class="s2">, sum=</span><span class="si">%e</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>            <span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>            <span class="k">return</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>        <span class="c1"># Set up pathline or time integral bounds and initial condition.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">velocity_gradient</span><span class="p">):</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>            <span class="k">if</span> <span class="n">pathline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>                    <span class="s2">&quot;unable to evaluate velocity gradient callable.&quot;</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>                    <span class="o">+</span> <span class="s2">&quot; You must provide the `pathline` to use a velocity gradient callable.&quot;</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a>                <span class="p">)</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a>            <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="n">get_position</span> <span class="o">=</span> <span class="n">pathline</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>            <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span><span class="p">(</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">get_position</span><span class="p">(</span><span class="n">time_start</span><span class="p">))</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a>                <span class="s2">&quot;calculating CPO at </span><span class="si">%s</span><span class="s2"> (t=</span><span class="si">%e</span><span class="s2">) with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a>                <span class="n">get_position</span><span class="p">(</span><span class="n">time_start</span><span class="p">),</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a>                <span class="n">time_start</span><span class="p">,</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>                <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>            <span class="p">)</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>            <span class="n">max_step</span> <span class="o">=</span> <span class="n">integration_time</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>            <span class="n">time_start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>            <span class="n">time_end</span> <span class="o">=</span> <span class="n">integration_time</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>                <span class="s2">&quot;calculating CPO for t=</span><span class="si">%e</span><span class="s2"> with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>                <span class="n">time_end</span> <span class="o">-</span> <span class="n">time_start</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>                <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>            <span class="p">)</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>            <span class="n">max_step</span> <span class="o">=</span> <span class="n">time_end</span> <span class="o">-</span> <span class="n">time_start</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>        <span class="n">strain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">+</span> <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a>        <span class="n">strain_rate_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">strain_rate</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a>        <span class="c1"># max_step = min(max_step, 1e-2 / strain_rate_max)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a>        <span class="c1"># max_step = 1e6</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">olivine</span><span class="p">:</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>            <span class="n">volume_fraction</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;olivine_fraction&quot;</span><span class="p">]</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">enstatite</span><span class="p">:</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a>            <span class="n">volume_fraction</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;enstatite_fraction&quot;</span><span class="p">]</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a>            <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># Should never happen.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a>        <span class="c1"># Initialise solver and perform first step.</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>        <span class="n">solver</span> <span class="o">=</span> <span class="n">RK45</span><span class="p">(</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>            <span class="n">eval_rhs</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>            <span class="n">time_start</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>                <span class="p">(</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>                    <span class="n">deformation_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>                <span class="p">)</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="p">),</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>            <span class="n">time_end</span><span class="p">,</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>            <span class="c1"># first_step=max_step / 4,  # TODO: Move divisor to config?</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>            <span class="n">max_step</span><span class="o">=</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>            <span class="c1"># atol=np.inf,  # FIXME: Different solver or smart way to set tolerance.</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>            <span class="k">raise</span> <span class="n">_err</span><span class="o">.</span><span class="n">IterationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> step_size=</span><span class="si">%e</span><span class="s2"> (max_step=</span><span class="si">%e</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>            <span class="n">solver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a>        <span class="p">)</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a>        <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">orientations</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fractions</span><span class="p">))</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a>        <span class="c1"># Solve ODE using numerical iteration scheme.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a>        <span class="k">while</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">velocity_gradient</span><span class="p">):</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>                <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span><span class="p">(</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">get_position</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>                    <span class="s2">&quot;calculating CPO at </span><span class="si">%s</span><span class="s2"> (t=</span><span class="si">%e</span><span class="s2">) with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>                    <span class="n">get_position</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>                    <span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>                    <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>                <span class="p">)</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>                <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>            <span class="n">strain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">+</span> <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>            <span class="n">strain_rate_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">strain_rate</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>            <span class="c1"># solver.max_step = min(solver.max_step, 1e-2 / strain_rate_max)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>            <span class="n">message</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>            <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>                <span class="k">raise</span> <span class="n">_err</span><span class="o">.</span><span class="n">IterationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> step_size=</span><span class="si">%e</span><span class="s2"> (max_step=</span><span class="si">%e</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>                <span class="n">solver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a>            <span class="p">)</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>            <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>            <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">orientations</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fractions</span><span class="p">))</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>        <span class="c1"># Extract final values for this simulation step, append to storage.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orientations</span><span class="p">)</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fractions</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>        <span class="k">return</span> <span class="n">deformation_gradient</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save CPO data for all stored timesteps to a `numpy` NPZ file.</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a><span class="sd">        If `postfix` is not `None`, the data is appended to the NPZ file</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a><span class="sd">        in fields ending with &quot;`_postfix`&quot;.</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a><span class="sd">        Raises a `ValueError` if the data shapes are not compatible.</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a><span class="sd">        See also: `numpy.savez`, `Mineral.load`, `Mineral.from_file`.</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">):</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>                <span class="s2">&quot;Length of stored results must match.&quot;</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>                <span class="o">+</span> <span class="s2">&quot; You&#39;ve supplied currupted data with:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span><span class="si">}</span><span class="s2"> grain size results, and</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">)</span><span class="si">}</span><span class="s2"> orientation results.&quot;</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>            <span class="p">)</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">:</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>                <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>                <span class="p">),</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>                <span class="s2">&quot;fractions&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>                <span class="s2">&quot;orientations&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">),</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>            <span class="p">}</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>            <span class="c1"># Create parent directories, resolve relative paths.</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>            <span class="n">_io</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>            <span class="c1"># Append to file, requires postfix (unique name).</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>            <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>                <span class="n">archive</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>                    <span class="k">with</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">force_zip64</span><span class="o">=</span><span class="kc">True</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>                    <span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>                        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>                        <span class="n">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>                <span class="s2">&quot;Size of CPO data arrays must match number of grains.&quot;</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>                <span class="o">+</span> <span class="s2">&quot; You&#39;ve supplied corrupted data with:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `n_grains = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="si">}</span><span class="s2">`,</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `fractions[0].shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">`, and</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `orientations[0].shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">`.&quot;</span>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a>            <span class="p">)</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load CPO data from a `numpy` NPZ file.</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a><span class="sd">        If `postfix` is not `None`, data is read from fields ending with &quot;`_postfix`&quot;.</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">        See also: `Mineral.save`, `Mineral.from_file`.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">):</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>                <span class="sa">f</span><span class="s2">&quot;Must only load from numpy NPZ format. Cannot load from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>            <span class="p">)</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;meta_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fractions_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;orientations_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fractions&quot;</span><span class="p">])</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">])</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fabric</span> <span class="o">=</span> <span class="n">fabric</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regime</span> <span class="o">=</span> <span class="n">regime</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>    <span class="nd">@classmethod</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a `Mineral` instance using data from a `numpy` NPZ file.</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a><span class="sd">        If `postfix` is not `None`, data is read from fields ending with `_postfix`.</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a><span class="sd">        See also: `Mineral.save`, `Mineral.load`.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">):</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a>                <span class="sa">f</span><span class="s2">&quot;Must only load from numpy NPZ format. Cannot load from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a>            <span class="p">)</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a>        <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;meta_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fractions_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;orientations_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fractions&quot;</span><span class="p">])</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">])</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="n">mineral</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>            <span class="n">phase</span><span class="p">,</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>            <span class="n">fabric</span><span class="p">,</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>            <span class="n">regime</span><span class="p">,</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>            <span class="n">n_grains</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>            <span class="n">fractions_init</span><span class="o">=</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>            <span class="n">orientations_init</span><span class="o">=</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>        <span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>        <span class="n">mineral</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="n">fractions</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="n">mineral</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="n">orientations</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="k">return</span> <span class="n">mineral</span>
</span></pre></div>


            </section>
                <section id="OlivineFabric">
                            <input id="OlivineFabric-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@unique</div>

    <span class="def">class</span>
    <span class="name">OlivineFabric</span><wbr>(<span class="base">enum.IntEnum</span>):

                <label class="view-source-button" for="OlivineFabric-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#OlivineFabric"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="OlivineFabric-28"><a href="#OlivineFabric-28"><span class="linenos">28</span></a><span class="nd">@unique</span>
</span><span id="OlivineFabric-29"><a href="#OlivineFabric-29"><span class="linenos">29</span></a><span class="k">class</span> <span class="nc">OlivineFabric</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
</span><span id="OlivineFabric-30"><a href="#OlivineFabric-30"><span class="linenos">30</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration type for olivine fabrics A-E.&quot;&quot;&quot;</span>
</span><span id="OlivineFabric-31"><a href="#OlivineFabric-31"><span class="linenos">31</span></a>
</span><span id="OlivineFabric-32"><a href="#OlivineFabric-32"><span class="linenos">32</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="OlivineFabric-33"><a href="#OlivineFabric-33"><span class="linenos">33</span></a>    <span class="n">B</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="OlivineFabric-34"><a href="#OlivineFabric-34"><span class="linenos">34</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="mi">2</span>
</span><span id="OlivineFabric-35"><a href="#OlivineFabric-35"><span class="linenos">35</span></a>    <span class="n">D</span> <span class="o">=</span> <span class="mi">3</span>
</span><span id="OlivineFabric-36"><a href="#OlivineFabric-36"><span class="linenos">36</span></a>    <span class="n">E</span> <span class="o">=</span> <span class="mi">4</span>
</span></pre></div>


            <div class="docstring"><p>Enumeration type for olivine fabrics A-E.</p>
</div>


                            <div id="OlivineFabric.A" class="classattr">
                                <div class="attr variable">
            <span class="name">A</span>        =
<span class="default_value">&lt;<a href="#OlivineFabric.A">OlivineFabric.A</a>: 0&gt;</span>

        
    </div>
    <a class="headerlink" href="#OlivineFabric.A"></a>
    
    

                            </div>
                            <div id="OlivineFabric.B" class="classattr">
                                <div class="attr variable">
            <span class="name">B</span>        =
<span class="default_value">&lt;<a href="#OlivineFabric.B">OlivineFabric.B</a>: 1&gt;</span>

        
    </div>
    <a class="headerlink" href="#OlivineFabric.B"></a>
    
    

                            </div>
                            <div id="OlivineFabric.C" class="classattr">
                                <div class="attr variable">
            <span class="name">C</span>        =
<span class="default_value">&lt;<a href="#OlivineFabric.C">OlivineFabric.C</a>: 2&gt;</span>

        
    </div>
    <a class="headerlink" href="#OlivineFabric.C"></a>
    
    

                            </div>
                            <div id="OlivineFabric.D" class="classattr">
                                <div class="attr variable">
            <span class="name">D</span>        =
<span class="default_value">&lt;<a href="#OlivineFabric.D">OlivineFabric.D</a>: 3&gt;</span>

        
    </div>
    <a class="headerlink" href="#OlivineFabric.D"></a>
    
    

                            </div>
                            <div id="OlivineFabric.E" class="classattr">
                                <div class="attr variable">
            <span class="name">E</span>        =
<span class="default_value">&lt;<a href="#OlivineFabric.E">OlivineFabric.E</a>: 4&gt;</span>

        
    </div>
    <a class="headerlink" href="#OlivineFabric.E"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="OlivineFabric.name" class="variable">name</dd>
                <dd id="OlivineFabric.value" class="variable">value</dd>

            </div>
            <div><dt>builtins.int</dt>
                                <dd id="OlivineFabric.conjugate" class="function">conjugate</dd>
                <dd id="OlivineFabric.bit_length" class="function">bit_length</dd>
                <dd id="OlivineFabric.bit_count" class="function">bit_count</dd>
                <dd id="OlivineFabric.to_bytes" class="function">to_bytes</dd>
                <dd id="OlivineFabric.from_bytes" class="function">from_bytes</dd>
                <dd id="OlivineFabric.as_integer_ratio" class="function">as_integer_ratio</dd>
                <dd id="OlivineFabric.real" class="variable">real</dd>
                <dd id="OlivineFabric.imag" class="variable">imag</dd>
                <dd id="OlivineFabric.numerator" class="variable">numerator</dd>
                <dd id="OlivineFabric.denominator" class="variable">denominator</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="EnstatiteFabric">
                            <input id="EnstatiteFabric-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@unique</div>

    <span class="def">class</span>
    <span class="name">EnstatiteFabric</span><wbr>(<span class="base">enum.IntEnum</span>):

                <label class="view-source-button" for="EnstatiteFabric-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EnstatiteFabric"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EnstatiteFabric-39"><a href="#EnstatiteFabric-39"><span class="linenos">39</span></a><span class="nd">@unique</span>
</span><span id="EnstatiteFabric-40"><a href="#EnstatiteFabric-40"><span class="linenos">40</span></a><span class="k">class</span> <span class="nc">EnstatiteFabric</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
</span><span id="EnstatiteFabric-41"><a href="#EnstatiteFabric-41"><span class="linenos">41</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Enumeration type with a single member A which is the only enstatite fabric.&quot;&quot;&quot;</span>
</span><span id="EnstatiteFabric-42"><a href="#EnstatiteFabric-42"><span class="linenos">42</span></a>
</span><span id="EnstatiteFabric-43"><a href="#EnstatiteFabric-43"><span class="linenos">43</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># Just to make it consistent.</span>
</span></pre></div>


            <div class="docstring"><p>Enumeration type with a single member A which is the only enstatite fabric.</p>
</div>


                            <div id="EnstatiteFabric.A" class="classattr">
                                <div class="attr variable">
            <span class="name">A</span>        =
<span class="default_value">&lt;<a href="#EnstatiteFabric.A">EnstatiteFabric.A</a>: 0&gt;</span>

        
    </div>
    <a class="headerlink" href="#EnstatiteFabric.A"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="EnstatiteFabric.name" class="variable">name</dd>
                <dd id="EnstatiteFabric.value" class="variable">value</dd>

            </div>
            <div><dt>builtins.int</dt>
                                <dd id="EnstatiteFabric.conjugate" class="function">conjugate</dd>
                <dd id="EnstatiteFabric.bit_length" class="function">bit_length</dd>
                <dd id="EnstatiteFabric.bit_count" class="function">bit_count</dd>
                <dd id="EnstatiteFabric.to_bytes" class="function">to_bytes</dd>
                <dd id="EnstatiteFabric.from_bytes" class="function">from_bytes</dd>
                <dd id="EnstatiteFabric.as_integer_ratio" class="function">as_integer_ratio</dd>
                <dd id="EnstatiteFabric.real" class="variable">real</dd>
                <dd id="EnstatiteFabric.imag" class="variable">imag</dd>
                <dd id="EnstatiteFabric.numerator" class="variable">numerator</dd>
                <dd id="EnstatiteFabric.denominator" class="variable">denominator</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="MineralPhase">
                            <input id="MineralPhase-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@unique</div>

    <span class="def">class</span>
    <span class="name">MineralPhase</span><wbr>(<span class="base">enum.IntEnum</span>):

                <label class="view-source-button" for="MineralPhase-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#MineralPhase"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="MineralPhase-46"><a href="#MineralPhase-46"><span class="linenos">46</span></a><span class="nd">@unique</span>
</span><span id="MineralPhase-47"><a href="#MineralPhase-47"><span class="linenos">47</span></a><span class="k">class</span> <span class="nc">MineralPhase</span><span class="p">(</span><span class="n">IntEnum</span><span class="p">):</span>
</span><span id="MineralPhase-48"><a href="#MineralPhase-48"><span class="linenos">48</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Supported mineral phases:</span>
</span><span id="MineralPhase-49"><a href="#MineralPhase-49"><span class="linenos">49</span></a>
</span><span id="MineralPhase-50"><a href="#MineralPhase-50"><span class="linenos">50</span></a><span class="sd">    - olivine (0)</span>
</span><span id="MineralPhase-51"><a href="#MineralPhase-51"><span class="linenos">51</span></a><span class="sd">    - enstatite (1)</span>
</span><span id="MineralPhase-52"><a href="#MineralPhase-52"><span class="linenos">52</span></a>
</span><span id="MineralPhase-53"><a href="#MineralPhase-53"><span class="linenos">53</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="MineralPhase-54"><a href="#MineralPhase-54"><span class="linenos">54</span></a>
</span><span id="MineralPhase-55"><a href="#MineralPhase-55"><span class="linenos">55</span></a>    <span class="n">olivine</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="MineralPhase-56"><a href="#MineralPhase-56"><span class="linenos">56</span></a>    <span class="n">enstatite</span> <span class="o">=</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Supported mineral phases:</p>

<ul>
<li>olivine (0)</li>
<li>enstatite (1)</li>
</ul>
</div>


                            <div id="MineralPhase.olivine" class="classattr">
                                <div class="attr variable">
            <span class="name">olivine</span>        =
<span class="default_value">&lt;<a href="#MineralPhase.olivine">MineralPhase.olivine</a>: 0&gt;</span>

        
    </div>
    <a class="headerlink" href="#MineralPhase.olivine"></a>
    
    

                            </div>
                            <div id="MineralPhase.enstatite" class="classattr">
                                <div class="attr variable">
            <span class="name">enstatite</span>        =
<span class="default_value">&lt;<a href="#MineralPhase.enstatite">MineralPhase.enstatite</a>: 1&gt;</span>

        
    </div>
    <a class="headerlink" href="#MineralPhase.enstatite"></a>
    
    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>enum.Enum</dt>
                                <dd id="MineralPhase.name" class="variable">name</dd>
                <dd id="MineralPhase.value" class="variable">value</dd>

            </div>
            <div><dt>builtins.int</dt>
                                <dd id="MineralPhase.conjugate" class="function">conjugate</dd>
                <dd id="MineralPhase.bit_length" class="function">bit_length</dd>
                <dd id="MineralPhase.bit_count" class="function">bit_count</dd>
                <dd id="MineralPhase.to_bytes" class="function">to_bytes</dd>
                <dd id="MineralPhase.from_bytes" class="function">from_bytes</dd>
                <dd id="MineralPhase.as_integer_ratio" class="function">as_integer_ratio</dd>
                <dd id="MineralPhase.real" class="variable">real</dd>
                <dd id="MineralPhase.imag" class="variable">imag</dd>
                <dd id="MineralPhase.numerator" class="variable">numerator</dd>
                <dd id="MineralPhase.denominator" class="variable">denominator</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="get_crss">
                            <input id="get_crss-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@nb.njit</div>

        <span class="def">def</span>
        <span class="name">get_crss</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">phase</span>, </span><span class="param"><span class="n">fabric</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_crss-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_crss"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_crss-59"><a href="#get_crss-59"><span class="linenos">59</span></a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
</span><span id="get_crss-60"><a href="#get_crss-60"><span class="linenos">60</span></a><span class="k">def</span> <span class="nf">get_crss</span><span class="p">(</span><span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">):</span>
</span><span id="get_crss-61"><a href="#get_crss-61"><span class="linenos">61</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get Critical Resolved Shear Stress for the mineral `phase` and `fabric`.</span>
</span><span id="get_crss-62"><a href="#get_crss-62"><span class="linenos">62</span></a>
</span><span id="get_crss-63"><a href="#get_crss-63"><span class="linenos">63</span></a><span class="sd">    Returns an array of the normalised threshold stresses required to activate slip</span>
</span><span id="get_crss-64"><a href="#get_crss-64"><span class="linenos">64</span></a><span class="sd">    on each slip system.</span>
</span><span id="get_crss-65"><a href="#get_crss-65"><span class="linenos">65</span></a>
</span><span id="get_crss-66"><a href="#get_crss-66"><span class="linenos">66</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_crss-67"><a href="#get_crss-67"><span class="linenos">67</span></a>    <span class="k">if</span> <span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">olivine</span><span class="p">:</span>
</span><span id="get_crss-68"><a href="#get_crss-68"><span class="linenos">68</span></a>        <span class="k">match</span> <span class="n">fabric</span><span class="p">:</span>
</span><span id="get_crss-69"><a href="#get_crss-69"><span class="linenos">69</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
</span><span id="get_crss-70"><a href="#get_crss-70"><span class="linenos">70</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="get_crss-71"><a href="#get_crss-71"><span class="linenos">71</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">B</span><span class="p">:</span>
</span><span id="get_crss-72"><a href="#get_crss-72"><span class="linenos">72</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="get_crss-73"><a href="#get_crss-73"><span class="linenos">73</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
</span><span id="get_crss-74"><a href="#get_crss-74"><span class="linenos">74</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="get_crss-75"><a href="#get_crss-75"><span class="linenos">75</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">D</span><span class="p">:</span>
</span><span id="get_crss-76"><a href="#get_crss-76"><span class="linenos">76</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="get_crss-77"><a href="#get_crss-77"><span class="linenos">77</span></a>            <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">E</span><span class="p">:</span>
</span><span id="get_crss-78"><a href="#get_crss-78"><span class="linenos">78</span></a>                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">])</span>
</span><span id="get_crss-79"><a href="#get_crss-79"><span class="linenos">79</span></a>            <span class="k">case</span><span class="w"> </span><span class="k">_</span><span class="p">:</span>
</span><span id="get_crss-80"><a href="#get_crss-80"><span class="linenos">80</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fabric must be a valid `OlivineFabric`&quot;</span><span class="p">)</span>
</span><span id="get_crss-81"><a href="#get_crss-81"><span class="linenos">81</span></a>    <span class="k">elif</span> <span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">enstatite</span><span class="p">:</span>
</span><span id="get_crss-82"><a href="#get_crss-82"><span class="linenos">82</span></a>        <span class="k">if</span> <span class="n">fabric</span> <span class="o">==</span> <span class="n">EnstatiteFabric</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
</span><span id="get_crss-83"><a href="#get_crss-83"><span class="linenos">83</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="get_crss-84"><a href="#get_crss-84"><span class="linenos">84</span></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;fabric must be a valid `EnstatiteFabric`&quot;</span><span class="p">)</span>
</span><span id="get_crss-85"><a href="#get_crss-85"><span class="linenos">85</span></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;phase must be a valid `MineralPhase`&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get Critical Resolved Shear Stress for the mineral <code>phase</code> and <code>fabric</code>.</p>

<p>Returns an array of the normalised threshold stresses required to activate slip
on each slip system.</p>
</div>


                </section>
                <section id="get_primary_axis">
                            <input id="get_primary_axis-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_primary_axis</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">fabric</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_primary_axis-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_primary_axis"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_primary_axis-88"><a href="#get_primary_axis-88"><span class="linenos"> 88</span></a><span class="k">def</span> <span class="nf">get_primary_axis</span><span class="p">(</span><span class="n">fabric</span><span class="p">):</span>
</span><span id="get_primary_axis-89"><a href="#get_primary_axis-89"><span class="linenos"> 89</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Get primary slip axis name for the given olivine `fabric`.&quot;&quot;&quot;</span>
</span><span id="get_primary_axis-90"><a href="#get_primary_axis-90"><span class="linenos"> 90</span></a>    <span class="k">match</span> <span class="n">fabric</span><span class="p">:</span>
</span><span id="get_primary_axis-91"><a href="#get_primary_axis-91"><span class="linenos"> 91</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">A</span><span class="p">:</span>
</span><span id="get_primary_axis-92"><a href="#get_primary_axis-92"><span class="linenos"> 92</span></a>            <span class="k">return</span> <span class="s2">&quot;a&quot;</span>
</span><span id="get_primary_axis-93"><a href="#get_primary_axis-93"><span class="linenos"> 93</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">B</span><span class="p">:</span>
</span><span id="get_primary_axis-94"><a href="#get_primary_axis-94"><span class="linenos"> 94</span></a>            <span class="k">return</span> <span class="s2">&quot;c&quot;</span>
</span><span id="get_primary_axis-95"><a href="#get_primary_axis-95"><span class="linenos"> 95</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">C</span><span class="p">:</span>
</span><span id="get_primary_axis-96"><a href="#get_primary_axis-96"><span class="linenos"> 96</span></a>            <span class="k">return</span> <span class="s2">&quot;c&quot;</span>
</span><span id="get_primary_axis-97"><a href="#get_primary_axis-97"><span class="linenos"> 97</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">D</span><span class="p">:</span>
</span><span id="get_primary_axis-98"><a href="#get_primary_axis-98"><span class="linenos"> 98</span></a>            <span class="k">return</span> <span class="s2">&quot;a&quot;</span>
</span><span id="get_primary_axis-99"><a href="#get_primary_axis-99"><span class="linenos"> 99</span></a>        <span class="k">case</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">E</span><span class="p">:</span>
</span><span id="get_primary_axis-100"><a href="#get_primary_axis-100"><span class="linenos">100</span></a>            <span class="k">return</span> <span class="s2">&quot;a&quot;</span>
</span><span id="get_primary_axis-101"><a href="#get_primary_axis-101"><span class="linenos">101</span></a>    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;fabric must be a valid `OlivineFabric`, not </span><span class="si">{</span><span class="n">fabric</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get primary slip axis name for the given olivine <code>fabric</code>.</p>
</div>


                </section>
                <section id="Mineral">
                            <input id="Mineral-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator">@dataclass</div>

    <span class="def">class</span>
    <span class="name">Mineral</span>:

                <label class="view-source-button" for="Mineral-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mineral"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mineral-104"><a href="#Mineral-104"><span class="linenos">104</span></a><span class="nd">@dataclass</span>
</span><span id="Mineral-105"><a href="#Mineral-105"><span class="linenos">105</span></a><span class="k">class</span> <span class="nc">Mineral</span><span class="p">:</span>
</span><span id="Mineral-106"><a href="#Mineral-106"><span class="linenos">106</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Class for storing mineral CPO.</span>
</span><span id="Mineral-107"><a href="#Mineral-107"><span class="linenos">107</span></a>
</span><span id="Mineral-108"><a href="#Mineral-108"><span class="linenos">108</span></a><span class="sd">    A `Mineral` stores CPO data for an aggregate of grains*.</span>
</span><span id="Mineral-109"><a href="#Mineral-109"><span class="linenos">109</span></a><span class="sd">    Additionally, mineral fabric type and deformation regime</span>
</span><span id="Mineral-110"><a href="#Mineral-110"><span class="linenos">110</span></a><span class="sd">    are also tracked. See `pydrex.deformation_mechanism`.</span>
</span><span id="Mineral-111"><a href="#Mineral-111"><span class="linenos">111</span></a>
</span><span id="Mineral-112"><a href="#Mineral-112"><span class="linenos">112</span></a><span class="sd">    Attributes:</span>
</span><span id="Mineral-113"><a href="#Mineral-113"><span class="linenos">113</span></a><span class="sd">    - `phase` (int)  ordinal number of the mineral phase, see `MineralPhase`</span>
</span><span id="Mineral-114"><a href="#Mineral-114"><span class="linenos">114</span></a><span class="sd">    - `fabric` (int)  ordinal number of the fabric type, see `OlivineFabric`</span>
</span><span id="Mineral-115"><a href="#Mineral-115"><span class="linenos">115</span></a><span class="sd">      and `EnstatiteFabric`</span>
</span><span id="Mineral-116"><a href="#Mineral-116"><span class="linenos">116</span></a><span class="sd">    - `regime` (int)  ordinal number of the deformation regime,</span>
</span><span id="Mineral-117"><a href="#Mineral-117"><span class="linenos">117</span></a><span class="sd">      see `pydrex.deformation_mechanism.Regime`</span>
</span><span id="Mineral-118"><a href="#Mineral-118"><span class="linenos">118</span></a><span class="sd">    - `n_grains` (int)  number of grains in the aggregate</span>
</span><span id="Mineral-119"><a href="#Mineral-119"><span class="linenos">119</span></a><span class="sd">    - `fractions_init` (array, optional)  initial dimensionless grain volumes</span>
</span><span id="Mineral-120"><a href="#Mineral-120"><span class="linenos">120</span></a><span class="sd">    - `orientations_init` (array, optional)  initial grain orientation matrices</span>
</span><span id="Mineral-121"><a href="#Mineral-121"><span class="linenos">121</span></a>
</span><span id="Mineral-122"><a href="#Mineral-122"><span class="linenos">122</span></a><span class="sd">    By default, a uniform volume distribution of random orientations is generated.</span>
</span><span id="Mineral-123"><a href="#Mineral-123"><span class="linenos">123</span></a>
</span><span id="Mineral-124"><a href="#Mineral-124"><span class="linenos">124</span></a><span class="sd">    *Note that &quot;grains&quot; is here an approximate term,</span>
</span><span id="Mineral-125"><a href="#Mineral-125"><span class="linenos">125</span></a><span class="sd">    and the stored objects do not fully correspond to physical grains.</span>
</span><span id="Mineral-126"><a href="#Mineral-126"><span class="linenos">126</span></a><span class="sd">    For example, the number of grains is fixed despite inclusion of</span>
</span><span id="Mineral-127"><a href="#Mineral-127"><span class="linenos">127</span></a><span class="sd">    grain nucleation in the modelling. It is assumed that new grains</span>
</span><span id="Mineral-128"><a href="#Mineral-128"><span class="linenos">128</span></a><span class="sd">    do not grow large enough to require independent rotation tracking.</span>
</span><span id="Mineral-129"><a href="#Mineral-129"><span class="linenos">129</span></a><span class="sd">    The DRex model is also unsuitable if static recrystallization is significant.</span>
</span><span id="Mineral-130"><a href="#Mineral-130"><span class="linenos">130</span></a>
</span><span id="Mineral-131"><a href="#Mineral-131"><span class="linenos">131</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Mineral-132"><a href="#Mineral-132"><span class="linenos">132</span></a>
</span><span id="Mineral-133"><a href="#Mineral-133"><span class="linenos">133</span></a>    <span class="n">phase</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">olivine</span>
</span><span id="Mineral-134"><a href="#Mineral-134"><span class="linenos">134</span></a>    <span class="n">fabric</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">OlivineFabric</span><span class="o">.</span><span class="n">A</span>
</span><span id="Mineral-135"><a href="#Mineral-135"><span class="linenos">135</span></a>    <span class="n">regime</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_defmech</span><span class="o">.</span><span class="n">Regime</span><span class="o">.</span><span class="n">dislocation</span>
</span><span id="Mineral-136"><a href="#Mineral-136"><span class="linenos">136</span></a>    <span class="n">n_grains</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="Mineral-137"><a href="#Mineral-137"><span class="linenos">137</span></a>    <span class="c1"># Initial condition, randomised if not given.</span>
</span><span id="Mineral-138"><a href="#Mineral-138"><span class="linenos">138</span></a>    <span class="n">fractions_init</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mineral-139"><a href="#Mineral-139"><span class="linenos">139</span></a>    <span class="n">orientations_init</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Mineral-140"><a href="#Mineral-140"><span class="linenos">140</span></a>    <span class="n">fractions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="Mineral-141"><a href="#Mineral-141"><span class="linenos">141</span></a>    <span class="n">orientations</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
</span><span id="Mineral-142"><a href="#Mineral-142"><span class="linenos">142</span></a>
</span><span id="Mineral-143"><a href="#Mineral-143"><span class="linenos">143</span></a>    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mineral-144"><a href="#Mineral-144"><span class="linenos">144</span></a>        <span class="c1"># String output, used for str(self) and f&quot;{self}&quot;, etc.</span>
</span><span id="Mineral-145"><a href="#Mineral-145"><span class="linenos">145</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
</span><span id="Mineral-146"><a href="#Mineral-146"><span class="linenos">146</span></a>            <span class="n">shape_of_fractions</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Mineral-147"><a href="#Mineral-147"><span class="linenos">147</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-148"><a href="#Mineral-148"><span class="linenos">148</span></a>            <span class="n">shape_of_fractions</span> <span class="o">=</span> <span class="s2">&quot;(?)&quot;</span>
</span><span id="Mineral-149"><a href="#Mineral-149"><span class="linenos">149</span></a>
</span><span id="Mineral-150"><a href="#Mineral-150"><span class="linenos">150</span></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
</span><span id="Mineral-151"><a href="#Mineral-151"><span class="linenos">151</span></a>            <span class="n">shape_of_orientations</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</span><span id="Mineral-152"><a href="#Mineral-152"><span class="linenos">152</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-153"><a href="#Mineral-153"><span class="linenos">153</span></a>            <span class="n">shape_of_orientations</span> <span class="o">=</span> <span class="s2">&quot;(?)&quot;</span>
</span><span id="Mineral-154"><a href="#Mineral-154"><span class="linenos">154</span></a>
</span><span id="Mineral-155"><a href="#Mineral-155"><span class="linenos">155</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Mineral-156"><a href="#Mineral-156"><span class="linenos">156</span></a>            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span>
</span><span id="Mineral-157"><a href="#Mineral-157"><span class="linenos">157</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;(phase=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="Mineral-158"><a href="#Mineral-158"><span class="linenos">158</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fabric=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="Mineral-159"><a href="#Mineral-159"><span class="linenos">159</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;regime=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">regime</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="Mineral-160"><a href="#Mineral-160"><span class="linenos">160</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;n_grains=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="si">!s}</span><span class="s2">, &quot;</span>
</span><span id="Mineral-161"><a href="#Mineral-161"><span class="linenos">161</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;fractions=&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Mineral-162"><a href="#Mineral-162"><span class="linenos">162</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shape_of_fractions</span><span class="si">}</span><span class="s2">&gt;, &quot;</span>
</span><span id="Mineral-163"><a href="#Mineral-163"><span class="linenos">163</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;orientations=&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Mineral-164"><a href="#Mineral-164"><span class="linenos">164</span></a>            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">shape_of_orientations</span><span class="si">}</span><span class="s2">&gt;)&quot;</span>
</span><span id="Mineral-165"><a href="#Mineral-165"><span class="linenos">165</span></a>        <span class="p">)</span>
</span><span id="Mineral-166"><a href="#Mineral-166"><span class="linenos">166</span></a>
</span><span id="Mineral-167"><a href="#Mineral-167"><span class="linenos">167</span></a>    <span class="k">def</span> <span class="nf">_repr_pretty_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">cycle</span><span class="p">):</span>
</span><span id="Mineral-168"><a href="#Mineral-168"><span class="linenos">168</span></a>        <span class="c1"># Format to use when printing to IPython or other interactive console.</span>
</span><span id="Mineral-169"><a href="#Mineral-169"><span class="linenos">169</span></a>        <span class="n">p</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">cycle</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span> <span class="o">+</span> <span class="s2">&quot;(...)&quot;</span><span class="p">)</span>
</span><span id="Mineral-170"><a href="#Mineral-170"><span class="linenos">170</span></a>
</span><span id="Mineral-171"><a href="#Mineral-171"><span class="linenos">171</span></a>    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Mineral-172"><a href="#Mineral-172"><span class="linenos">172</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialise random orientations and grain volume fractions.&quot;&quot;&quot;</span>
</span><span id="Mineral-173"><a href="#Mineral-173"><span class="linenos">173</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral-174"><a href="#Mineral-174"><span class="linenos">174</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">)</span>
</span><span id="Mineral-175"><a href="#Mineral-175"><span class="linenos">175</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral-176"><a href="#Mineral-176"><span class="linenos">176</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span> <span class="o">=</span> <span class="n">Rotation</span><span class="o">.</span><span class="n">random</span><span class="p">(</span>
</span><span id="Mineral-177"><a href="#Mineral-177"><span class="linenos">177</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1</span>
</span><span id="Mineral-178"><a href="#Mineral-178"><span class="linenos">178</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">as_matrix</span><span class="p">()</span>
</span><span id="Mineral-179"><a href="#Mineral-179"><span class="linenos">179</span></a>
</span><span id="Mineral-180"><a href="#Mineral-180"><span class="linenos">180</span></a>        <span class="c1"># Copy the initial values to the storage lists.</span>
</span><span id="Mineral-181"><a href="#Mineral-181"><span class="linenos">181</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span><span class="p">)</span>
</span><span id="Mineral-182"><a href="#Mineral-182"><span class="linenos">182</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span><span class="p">)</span>
</span><span id="Mineral-183"><a href="#Mineral-183"><span class="linenos">183</span></a>
</span><span id="Mineral-184"><a href="#Mineral-184"><span class="linenos">184</span></a>        <span class="c1"># Delete the initial value duplicates to avoid confusion.</span>
</span><span id="Mineral-185"><a href="#Mineral-185"><span class="linenos">185</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span>
</span><span id="Mineral-186"><a href="#Mineral-186"><span class="linenos">186</span></a>        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span>
</span><span id="Mineral-187"><a href="#Mineral-187"><span class="linenos">187</span></a>
</span><span id="Mineral-188"><a href="#Mineral-188"><span class="linenos">188</span></a>        <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;created </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
</span><span id="Mineral-189"><a href="#Mineral-189"><span class="linenos">189</span></a>
</span><span id="Mineral-190"><a href="#Mineral-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="nf">update_orientations</span><span class="p">(</span>
</span><span id="Mineral-191"><a href="#Mineral-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mineral-192"><a href="#Mineral-192"><span class="linenos">192</span></a>        <span class="n">config</span><span class="p">,</span>
</span><span id="Mineral-193"><a href="#Mineral-193"><span class="linenos">193</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span>
</span><span id="Mineral-194"><a href="#Mineral-194"><span class="linenos">194</span></a>        <span class="n">velocity_gradient</span><span class="p">,</span>
</span><span id="Mineral-195"><a href="#Mineral-195"><span class="linenos">195</span></a>        <span class="n">integration_time</span><span class="p">,</span>
</span><span id="Mineral-196"><a href="#Mineral-196"><span class="linenos">196</span></a>        <span class="n">pathline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mineral-197"><a href="#Mineral-197"><span class="linenos">197</span></a>    <span class="p">):</span>
</span><span id="Mineral-198"><a href="#Mineral-198"><span class="linenos">198</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update orientations and volume distribution for the `Mineral`.</span>
</span><span id="Mineral-199"><a href="#Mineral-199"><span class="linenos">199</span></a>
</span><span id="Mineral-200"><a href="#Mineral-200"><span class="linenos">200</span></a><span class="sd">        Update crystalline orientations and grain volume distribution</span>
</span><span id="Mineral-201"><a href="#Mineral-201"><span class="linenos">201</span></a><span class="sd">        for minerals undergoing plastic deformation.</span>
</span><span id="Mineral-202"><a href="#Mineral-202"><span class="linenos">202</span></a>
</span><span id="Mineral-203"><a href="#Mineral-203"><span class="linenos">203</span></a><span class="sd">        Args:</span>
</span><span id="Mineral-204"><a href="#Mineral-204"><span class="linenos">204</span></a><span class="sd">        - `config` (dict)  PyDRex configuration dictionary</span>
</span><span id="Mineral-205"><a href="#Mineral-205"><span class="linenos">205</span></a><span class="sd">        - `deformation_gradient` (array)  3x3 initial deformation gradient tensor</span>
</span><span id="Mineral-206"><a href="#Mineral-206"><span class="linenos">206</span></a><span class="sd">        - `velocity_gradient` (array or function)  3x3 velocity gradient matrix,</span>
</span><span id="Mineral-207"><a href="#Mineral-207"><span class="linenos">207</span></a><span class="sd">          or an interpolator that returns the 3x3 matrix when evaluated at a point</span>
</span><span id="Mineral-208"><a href="#Mineral-208"><span class="linenos">208</span></a><span class="sd">          along the provided pathline</span>
</span><span id="Mineral-209"><a href="#Mineral-209"><span class="linenos">209</span></a><span class="sd">        - `integration_time` (float)  total time of integrated dislocation</span>
</span><span id="Mineral-210"><a href="#Mineral-210"><span class="linenos">210</span></a><span class="sd">          creep (if `pathline` is not None, this is used as the maximum</span>
</span><span id="Mineral-211"><a href="#Mineral-211"><span class="linenos">211</span></a><span class="sd">          integration timestep during CPO calculation)</span>
</span><span id="Mineral-212"><a href="#Mineral-212"><span class="linenos">212</span></a><span class="sd">        - `pathline` (tuple, optional)  tuple consisting of:</span>
</span><span id="Mineral-213"><a href="#Mineral-213"><span class="linenos">213</span></a><span class="sd">            1. the time at which to start the CPO integration</span>
</span><span id="Mineral-214"><a href="#Mineral-214"><span class="linenos">214</span></a><span class="sd">            2. the time at which to stop the CPO integration</span>
</span><span id="Mineral-215"><a href="#Mineral-215"><span class="linenos">215</span></a><span class="sd">            3. a callable that accepts a time value and returns the position of</span>
</span><span id="Mineral-216"><a href="#Mineral-216"><span class="linenos">216</span></a><span class="sd">               the mineral</span>
</span><span id="Mineral-217"><a href="#Mineral-217"><span class="linenos">217</span></a>
</span><span id="Mineral-218"><a href="#Mineral-218"><span class="linenos">218</span></a><span class="sd">        Array values must provide a NumPy-compatible interface:</span>
</span><span id="Mineral-219"><a href="#Mineral-219"><span class="linenos">219</span></a><span class="sd">        &lt;https://numpy.org/doc/stable/user/whatisnumpy.html&gt;</span>
</span><span id="Mineral-220"><a href="#Mineral-220"><span class="linenos">220</span></a>
</span><span id="Mineral-221"><a href="#Mineral-221"><span class="linenos">221</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral-222"><a href="#Mineral-222"><span class="linenos">222</span></a>
</span><span id="Mineral-223"><a href="#Mineral-223"><span class="linenos">223</span></a>        <span class="c1"># Set up callables for the ODE, some variables come from enclosing scope.</span>
</span><span id="Mineral-224"><a href="#Mineral-224"><span class="linenos">224</span></a>        <span class="k">def</span> <span class="nf">extract_vars</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
</span><span id="Mineral-225"><a href="#Mineral-225"><span class="linenos">225</span></a>            <span class="c1"># TODO: Check if we can avoid .copy() here.</span>
</span><span id="Mineral-226"><a href="#Mineral-226"><span class="linenos">226</span></a>            <span class="n">deformation_gradient</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Mineral-227"><a href="#Mineral-227"><span class="linenos">227</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mineral-228"><a href="#Mineral-228"><span class="linenos">228</span></a>                <span class="n">y</span><span class="p">[</span><span class="mi">9</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span>
</span><span id="Mineral-229"><a href="#Mineral-229"><span class="linenos">229</span></a>                <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Mineral-230"><a href="#Mineral-230"><span class="linenos">230</span></a>                <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Mineral-231"><a href="#Mineral-231"><span class="linenos">231</span></a>                <span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Mineral-232"><a href="#Mineral-232"><span class="linenos">232</span></a>            <span class="p">)</span>
</span><span id="Mineral-233"><a href="#Mineral-233"><span class="linenos">233</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mineral-234"><a href="#Mineral-234"><span class="linenos">234</span></a>                <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Mineral-235"><a href="#Mineral-235"><span class="linenos">235</span></a>            <span class="p">)</span>
</span><span id="Mineral-236"><a href="#Mineral-236"><span class="linenos">236</span></a>            <span class="c1"># FIXME: Guard against zero-division? Why is .sum  0?</span>
</span><span id="Mineral-237"><a href="#Mineral-237"><span class="linenos">237</span></a>            <span class="n">fractions</span> <span class="o">/=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Mineral-238"><a href="#Mineral-238"><span class="linenos">238</span></a>            <span class="k">return</span> <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span>
</span><span id="Mineral-239"><a href="#Mineral-239"><span class="linenos">239</span></a>
</span><span id="Mineral-240"><a href="#Mineral-240"><span class="linenos">240</span></a>        <span class="k">def</span> <span class="nf">eval_rhs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="Mineral-241"><a href="#Mineral-241"><span class="linenos">241</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate right hand side of the D-Rex PDE.&quot;&quot;&quot;</span>
</span><span id="Mineral-242"><a href="#Mineral-242"><span class="linenos">242</span></a>            <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="Mineral-243"><a href="#Mineral-243"><span class="linenos">243</span></a>            <span class="c1"># Uses nondimensional values of strain rate and velocity gradient.</span>
</span><span id="Mineral-244"><a href="#Mineral-244"><span class="linenos">244</span></a>            <span class="n">orientations_diff</span><span class="p">,</span> <span class="n">fractions_diff</span> <span class="o">=</span> <span class="n">_core</span><span class="o">.</span><span class="n">derivatives</span><span class="p">(</span>
</span><span id="Mineral-245"><a href="#Mineral-245"><span class="linenos">245</span></a>                <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
</span><span id="Mineral-246"><a href="#Mineral-246"><span class="linenos">246</span></a>                <span class="n">fabric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="p">,</span>
</span><span id="Mineral-247"><a href="#Mineral-247"><span class="linenos">247</span></a>                <span class="n">n_grains</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span>
</span><span id="Mineral-248"><a href="#Mineral-248"><span class="linenos">248</span></a>                <span class="n">orientations</span><span class="o">=</span><span class="n">orientations</span><span class="p">,</span>
</span><span id="Mineral-249"><a href="#Mineral-249"><span class="linenos">249</span></a>                <span class="n">fractions</span><span class="o">=</span><span class="n">fractions</span><span class="p">,</span>
</span><span id="Mineral-250"><a href="#Mineral-250"><span class="linenos">250</span></a>                <span class="n">strain_rate</span><span class="o">=</span><span class="n">strain_rate</span> <span class="o">/</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral-251"><a href="#Mineral-251"><span class="linenos">251</span></a>                <span class="n">velocity_gradient</span><span class="o">=</span><span class="n">_velocity_gradient</span> <span class="o">/</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral-252"><a href="#Mineral-252"><span class="linenos">252</span></a>                <span class="n">stress_exponent</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;stress_exponent&quot;</span><span class="p">],</span>
</span><span id="Mineral-253"><a href="#Mineral-253"><span class="linenos">253</span></a>                <span class="n">deformation_exponent</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;deformation_exponent&quot;</span><span class="p">],</span>
</span><span id="Mineral-254"><a href="#Mineral-254"><span class="linenos">254</span></a>                <span class="n">nucleation_efficiency</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nucleation_efficiency&quot;</span><span class="p">],</span>
</span><span id="Mineral-255"><a href="#Mineral-255"><span class="linenos">255</span></a>                <span class="n">gbm_mobility</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbm_mobility&quot;</span><span class="p">],</span>
</span><span id="Mineral-256"><a href="#Mineral-256"><span class="linenos">256</span></a>                <span class="n">volume_fraction</span><span class="o">=</span><span class="n">volume_fraction</span><span class="p">,</span>
</span><span id="Mineral-257"><a href="#Mineral-257"><span class="linenos">257</span></a>            <span class="p">)</span>
</span><span id="Mineral-258"><a href="#Mineral-258"><span class="linenos">258</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
</span><span id="Mineral-259"><a href="#Mineral-259"><span class="linenos">259</span></a>                <span class="p">(</span>
</span><span id="Mineral-260"><a href="#Mineral-260"><span class="linenos">260</span></a>                    <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">@</span> <span class="n">deformation_gradient</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral-261"><a href="#Mineral-261"><span class="linenos">261</span></a>                    <span class="n">orientations_diff</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral-262"><a href="#Mineral-262"><span class="linenos">262</span></a>                    <span class="n">fractions_diff</span> <span class="o">*</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral-263"><a href="#Mineral-263"><span class="linenos">263</span></a>                <span class="p">)</span>
</span><span id="Mineral-264"><a href="#Mineral-264"><span class="linenos">264</span></a>            <span class="p">)</span>
</span><span id="Mineral-265"><a href="#Mineral-265"><span class="linenos">265</span></a>
</span><span id="Mineral-266"><a href="#Mineral-266"><span class="linenos">266</span></a>        <span class="k">def</span> <span class="nf">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span id="Mineral-267"><a href="#Mineral-267"><span class="linenos">267</span></a>            <span class="c1"># Grain boundary sliding for small grains.</span>
</span><span id="Mineral-268"><a href="#Mineral-268"><span class="linenos">268</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">fractions</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbs_threshold&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span>
</span><span id="Mineral-269"><a href="#Mineral-269"><span class="linenos">269</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral-270"><a href="#Mineral-270"><span class="linenos">270</span></a>                <span class="s2">&quot;grain boundary sliding activity (volume percentage): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral-271"><a href="#Mineral-271"><span class="linenos">271</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral-272"><a href="#Mineral-272"><span class="linenos">272</span></a>            <span class="p">)</span>
</span><span id="Mineral-273"><a href="#Mineral-273"><span class="linenos">273</span></a>            <span class="c1"># No rotation: carry over previous orientations.</span>
</span><span id="Mineral-274"><a href="#Mineral-274"><span class="linenos">274</span></a>            <span class="n">orientations</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="Mineral-275"><a href="#Mineral-275"><span class="linenos">275</span></a>            <span class="n">fractions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbs_threshold&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span>
</span><span id="Mineral-276"><a href="#Mineral-276"><span class="linenos">276</span></a>            <span class="c1"># FIXME: Guard against zero-division? Why is .sum  0?</span>
</span><span id="Mineral-277"><a href="#Mineral-277"><span class="linenos">277</span></a>            <span class="n">fractions</span> <span class="o">/=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Mineral-278"><a href="#Mineral-278"><span class="linenos">278</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral-279"><a href="#Mineral-279"><span class="linenos">279</span></a>                <span class="s2">&quot;grain volume fractions: median=</span><span class="si">%e</span><span class="s2">, min=</span><span class="si">%e</span><span class="s2">, max=</span><span class="si">%e</span><span class="s2">, sum=</span><span class="si">%e</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral-280"><a href="#Mineral-280"><span class="linenos">280</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral-281"><a href="#Mineral-281"><span class="linenos">281</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral-282"><a href="#Mineral-282"><span class="linenos">282</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral-283"><a href="#Mineral-283"><span class="linenos">283</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral-284"><a href="#Mineral-284"><span class="linenos">284</span></a>            <span class="p">)</span>
</span><span id="Mineral-285"><a href="#Mineral-285"><span class="linenos">285</span></a>            <span class="k">return</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span>
</span><span id="Mineral-286"><a href="#Mineral-286"><span class="linenos">286</span></a>
</span><span id="Mineral-287"><a href="#Mineral-287"><span class="linenos">287</span></a>        <span class="c1"># Set up pathline or time integral bounds and initial condition.</span>
</span><span id="Mineral-288"><a href="#Mineral-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">velocity_gradient</span><span class="p">):</span>
</span><span id="Mineral-289"><a href="#Mineral-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="n">pathline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral-290"><a href="#Mineral-290"><span class="linenos">290</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral-291"><a href="#Mineral-291"><span class="linenos">291</span></a>                    <span class="s2">&quot;unable to evaluate velocity gradient callable.&quot;</span>
</span><span id="Mineral-292"><a href="#Mineral-292"><span class="linenos">292</span></a>                    <span class="o">+</span> <span class="s2">&quot; You must provide the `pathline` to use a velocity gradient callable.&quot;</span>
</span><span id="Mineral-293"><a href="#Mineral-293"><span class="linenos">293</span></a>                <span class="p">)</span>
</span><span id="Mineral-294"><a href="#Mineral-294"><span class="linenos">294</span></a>            <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="n">get_position</span> <span class="o">=</span> <span class="n">pathline</span>
</span><span id="Mineral-295"><a href="#Mineral-295"><span class="linenos">295</span></a>            <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span><span class="p">(</span>
</span><span id="Mineral-296"><a href="#Mineral-296"><span class="linenos">296</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">get_position</span><span class="p">(</span><span class="n">time_start</span><span class="p">))</span>
</span><span id="Mineral-297"><a href="#Mineral-297"><span class="linenos">297</span></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Mineral-298"><a href="#Mineral-298"><span class="linenos">298</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="Mineral-299"><a href="#Mineral-299"><span class="linenos">299</span></a>                <span class="s2">&quot;calculating CPO at </span><span class="si">%s</span><span class="s2"> (t=</span><span class="si">%e</span><span class="s2">) with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral-300"><a href="#Mineral-300"><span class="linenos">300</span></a>                <span class="n">get_position</span><span class="p">(</span><span class="n">time_start</span><span class="p">),</span>
</span><span id="Mineral-301"><a href="#Mineral-301"><span class="linenos">301</span></a>                <span class="n">time_start</span><span class="p">,</span>
</span><span id="Mineral-302"><a href="#Mineral-302"><span class="linenos">302</span></a>                <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral-303"><a href="#Mineral-303"><span class="linenos">303</span></a>            <span class="p">)</span>
</span><span id="Mineral-304"><a href="#Mineral-304"><span class="linenos">304</span></a>            <span class="n">max_step</span> <span class="o">=</span> <span class="n">integration_time</span>
</span><span id="Mineral-305"><a href="#Mineral-305"><span class="linenos">305</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-306"><a href="#Mineral-306"><span class="linenos">306</span></a>            <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span>
</span><span id="Mineral-307"><a href="#Mineral-307"><span class="linenos">307</span></a>            <span class="n">time_start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Mineral-308"><a href="#Mineral-308"><span class="linenos">308</span></a>            <span class="n">time_end</span> <span class="o">=</span> <span class="n">integration_time</span>
</span><span id="Mineral-309"><a href="#Mineral-309"><span class="linenos">309</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="Mineral-310"><a href="#Mineral-310"><span class="linenos">310</span></a>                <span class="s2">&quot;calculating CPO for t=</span><span class="si">%e</span><span class="s2"> with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral-311"><a href="#Mineral-311"><span class="linenos">311</span></a>                <span class="n">time_end</span> <span class="o">-</span> <span class="n">time_start</span><span class="p">,</span>
</span><span id="Mineral-312"><a href="#Mineral-312"><span class="linenos">312</span></a>                <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral-313"><a href="#Mineral-313"><span class="linenos">313</span></a>            <span class="p">)</span>
</span><span id="Mineral-314"><a href="#Mineral-314"><span class="linenos">314</span></a>            <span class="n">max_step</span> <span class="o">=</span> <span class="n">time_end</span> <span class="o">-</span> <span class="n">time_start</span>
</span><span id="Mineral-315"><a href="#Mineral-315"><span class="linenos">315</span></a>
</span><span id="Mineral-316"><a href="#Mineral-316"><span class="linenos">316</span></a>        <span class="n">strain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">+</span> <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="Mineral-317"><a href="#Mineral-317"><span class="linenos">317</span></a>        <span class="n">strain_rate_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">strain_rate</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="Mineral-318"><a href="#Mineral-318"><span class="linenos">318</span></a>        <span class="c1"># max_step = min(max_step, 1e-2 / strain_rate_max)</span>
</span><span id="Mineral-319"><a href="#Mineral-319"><span class="linenos">319</span></a>        <span class="c1"># max_step = 1e6</span>
</span><span id="Mineral-320"><a href="#Mineral-320"><span class="linenos">320</span></a>
</span><span id="Mineral-321"><a href="#Mineral-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">olivine</span><span class="p">:</span>
</span><span id="Mineral-322"><a href="#Mineral-322"><span class="linenos">322</span></a>            <span class="n">volume_fraction</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;olivine_fraction&quot;</span><span class="p">]</span>
</span><span id="Mineral-323"><a href="#Mineral-323"><span class="linenos">323</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">enstatite</span><span class="p">:</span>
</span><span id="Mineral-324"><a href="#Mineral-324"><span class="linenos">324</span></a>            <span class="n">volume_fraction</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;enstatite_fraction&quot;</span><span class="p">]</span>
</span><span id="Mineral-325"><a href="#Mineral-325"><span class="linenos">325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-326"><a href="#Mineral-326"><span class="linenos">326</span></a>            <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># Should never happen.</span>
</span><span id="Mineral-327"><a href="#Mineral-327"><span class="linenos">327</span></a>
</span><span id="Mineral-328"><a href="#Mineral-328"><span class="linenos">328</span></a>        <span class="c1"># Initialise solver and perform first step.</span>
</span><span id="Mineral-329"><a href="#Mineral-329"><span class="linenos">329</span></a>        <span class="n">solver</span> <span class="o">=</span> <span class="n">RK45</span><span class="p">(</span>
</span><span id="Mineral-330"><a href="#Mineral-330"><span class="linenos">330</span></a>            <span class="n">eval_rhs</span><span class="p">,</span>
</span><span id="Mineral-331"><a href="#Mineral-331"><span class="linenos">331</span></a>            <span class="n">time_start</span><span class="p">,</span>
</span><span id="Mineral-332"><a href="#Mineral-332"><span class="linenos">332</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
</span><span id="Mineral-333"><a href="#Mineral-333"><span class="linenos">333</span></a>                <span class="p">(</span>
</span><span id="Mineral-334"><a href="#Mineral-334"><span class="linenos">334</span></a>                    <span class="n">deformation_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral-335"><a href="#Mineral-335"><span class="linenos">335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral-336"><a href="#Mineral-336"><span class="linenos">336</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Mineral-337"><a href="#Mineral-337"><span class="linenos">337</span></a>                <span class="p">)</span>
</span><span id="Mineral-338"><a href="#Mineral-338"><span class="linenos">338</span></a>            <span class="p">),</span>
</span><span id="Mineral-339"><a href="#Mineral-339"><span class="linenos">339</span></a>            <span class="n">time_end</span><span class="p">,</span>
</span><span id="Mineral-340"><a href="#Mineral-340"><span class="linenos">340</span></a>            <span class="c1"># first_step=max_step / 4,  # TODO: Move divisor to config?</span>
</span><span id="Mineral-341"><a href="#Mineral-341"><span class="linenos">341</span></a>            <span class="n">max_step</span><span class="o">=</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="Mineral-342"><a href="#Mineral-342"><span class="linenos">342</span></a>            <span class="c1"># atol=np.inf,  # FIXME: Different solver or smart way to set tolerance.</span>
</span><span id="Mineral-343"><a href="#Mineral-343"><span class="linenos">343</span></a>        <span class="p">)</span>
</span><span id="Mineral-344"><a href="#Mineral-344"><span class="linenos">344</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="Mineral-345"><a href="#Mineral-345"><span class="linenos">345</span></a>        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
</span><span id="Mineral-346"><a href="#Mineral-346"><span class="linenos">346</span></a>            <span class="k">raise</span> <span class="n">_err</span><span class="o">.</span><span class="n">IterationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="Mineral-347"><a href="#Mineral-347"><span class="linenos">347</span></a>        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral-348"><a href="#Mineral-348"><span class="linenos">348</span></a>            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> step_size=</span><span class="si">%e</span><span class="s2"> (max_step=</span><span class="si">%e</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="Mineral-349"><a href="#Mineral-349"><span class="linenos">349</span></a>            <span class="n">solver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="Mineral-350"><a href="#Mineral-350"><span class="linenos">350</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
</span><span id="Mineral-351"><a href="#Mineral-351"><span class="linenos">351</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="Mineral-352"><a href="#Mineral-352"><span class="linenos">352</span></a>        <span class="p">)</span>
</span><span id="Mineral-353"><a href="#Mineral-353"><span class="linenos">353</span></a>
</span><span id="Mineral-354"><a href="#Mineral-354"><span class="linenos">354</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Mineral-355"><a href="#Mineral-355"><span class="linenos">355</span></a>        <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="Mineral-356"><a href="#Mineral-356"><span class="linenos">356</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">orientations</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fractions</span><span class="p">))</span>
</span><span id="Mineral-357"><a href="#Mineral-357"><span class="linenos">357</span></a>
</span><span id="Mineral-358"><a href="#Mineral-358"><span class="linenos">358</span></a>        <span class="c1"># Solve ODE using numerical iteration scheme.</span>
</span><span id="Mineral-359"><a href="#Mineral-359"><span class="linenos">359</span></a>        <span class="k">while</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
</span><span id="Mineral-360"><a href="#Mineral-360"><span class="linenos">360</span></a>            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">velocity_gradient</span><span class="p">):</span>
</span><span id="Mineral-361"><a href="#Mineral-361"><span class="linenos">361</span></a>                <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span><span class="p">(</span>
</span><span id="Mineral-362"><a href="#Mineral-362"><span class="linenos">362</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">get_position</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
</span><span id="Mineral-363"><a href="#Mineral-363"><span class="linenos">363</span></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Mineral-364"><a href="#Mineral-364"><span class="linenos">364</span></a>                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="Mineral-365"><a href="#Mineral-365"><span class="linenos">365</span></a>                    <span class="s2">&quot;calculating CPO at </span><span class="si">%s</span><span class="s2"> (t=</span><span class="si">%e</span><span class="s2">) with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral-366"><a href="#Mineral-366"><span class="linenos">366</span></a>                    <span class="n">get_position</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
</span><span id="Mineral-367"><a href="#Mineral-367"><span class="linenos">367</span></a>                    <span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
</span><span id="Mineral-368"><a href="#Mineral-368"><span class="linenos">368</span></a>                    <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral-369"><a href="#Mineral-369"><span class="linenos">369</span></a>                <span class="p">)</span>
</span><span id="Mineral-370"><a href="#Mineral-370"><span class="linenos">370</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-371"><a href="#Mineral-371"><span class="linenos">371</span></a>                <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span>
</span><span id="Mineral-372"><a href="#Mineral-372"><span class="linenos">372</span></a>
</span><span id="Mineral-373"><a href="#Mineral-373"><span class="linenos">373</span></a>            <span class="n">strain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">+</span> <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="Mineral-374"><a href="#Mineral-374"><span class="linenos">374</span></a>            <span class="n">strain_rate_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">strain_rate</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="Mineral-375"><a href="#Mineral-375"><span class="linenos">375</span></a>            <span class="c1"># solver.max_step = min(solver.max_step, 1e-2 / strain_rate_max)</span>
</span><span id="Mineral-376"><a href="#Mineral-376"><span class="linenos">376</span></a>
</span><span id="Mineral-377"><a href="#Mineral-377"><span class="linenos">377</span></a>            <span class="n">message</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="Mineral-378"><a href="#Mineral-378"><span class="linenos">378</span></a>            <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
</span><span id="Mineral-379"><a href="#Mineral-379"><span class="linenos">379</span></a>                <span class="k">raise</span> <span class="n">_err</span><span class="o">.</span><span class="n">IterationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="Mineral-380"><a href="#Mineral-380"><span class="linenos">380</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral-381"><a href="#Mineral-381"><span class="linenos">381</span></a>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> step_size=</span><span class="si">%e</span><span class="s2"> (max_step=</span><span class="si">%e</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="Mineral-382"><a href="#Mineral-382"><span class="linenos">382</span></a>                <span class="n">solver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="Mineral-383"><a href="#Mineral-383"><span class="linenos">383</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
</span><span id="Mineral-384"><a href="#Mineral-384"><span class="linenos">384</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="Mineral-385"><a href="#Mineral-385"><span class="linenos">385</span></a>            <span class="p">)</span>
</span><span id="Mineral-386"><a href="#Mineral-386"><span class="linenos">386</span></a>
</span><span id="Mineral-387"><a href="#Mineral-387"><span class="linenos">387</span></a>            <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Mineral-388"><a href="#Mineral-388"><span class="linenos">388</span></a>            <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="Mineral-389"><a href="#Mineral-389"><span class="linenos">389</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">orientations</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fractions</span><span class="p">))</span>
</span><span id="Mineral-390"><a href="#Mineral-390"><span class="linenos">390</span></a>
</span><span id="Mineral-391"><a href="#Mineral-391"><span class="linenos">391</span></a>        <span class="c1"># Extract final values for this simulation step, append to storage.</span>
</span><span id="Mineral-392"><a href="#Mineral-392"><span class="linenos">392</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</span><span id="Mineral-393"><a href="#Mineral-393"><span class="linenos">393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orientations</span><span class="p">)</span>
</span><span id="Mineral-394"><a href="#Mineral-394"><span class="linenos">394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fractions</span><span class="p">)</span>
</span><span id="Mineral-395"><a href="#Mineral-395"><span class="linenos">395</span></a>        <span class="k">return</span> <span class="n">deformation_gradient</span>
</span><span id="Mineral-396"><a href="#Mineral-396"><span class="linenos">396</span></a>
</span><span id="Mineral-397"><a href="#Mineral-397"><span class="linenos">397</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mineral-398"><a href="#Mineral-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save CPO data for all stored timesteps to a `numpy` NPZ file.</span>
</span><span id="Mineral-399"><a href="#Mineral-399"><span class="linenos">399</span></a>
</span><span id="Mineral-400"><a href="#Mineral-400"><span class="linenos">400</span></a><span class="sd">        If `postfix` is not `None`, the data is appended to the NPZ file</span>
</span><span id="Mineral-401"><a href="#Mineral-401"><span class="linenos">401</span></a><span class="sd">        in fields ending with &quot;`_postfix`&quot;.</span>
</span><span id="Mineral-402"><a href="#Mineral-402"><span class="linenos">402</span></a>
</span><span id="Mineral-403"><a href="#Mineral-403"><span class="linenos">403</span></a><span class="sd">        Raises a `ValueError` if the data shapes are not compatible.</span>
</span><span id="Mineral-404"><a href="#Mineral-404"><span class="linenos">404</span></a>
</span><span id="Mineral-405"><a href="#Mineral-405"><span class="linenos">405</span></a><span class="sd">        See also: `numpy.savez`, `Mineral.load`, `Mineral.from_file`.</span>
</span><span id="Mineral-406"><a href="#Mineral-406"><span class="linenos">406</span></a>
</span><span id="Mineral-407"><a href="#Mineral-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral-408"><a href="#Mineral-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">):</span>
</span><span id="Mineral-409"><a href="#Mineral-409"><span class="linenos">409</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral-410"><a href="#Mineral-410"><span class="linenos">410</span></a>                <span class="s2">&quot;Length of stored results must match.&quot;</span>
</span><span id="Mineral-411"><a href="#Mineral-411"><span class="linenos">411</span></a>                <span class="o">+</span> <span class="s2">&quot; You&#39;ve supplied currupted data with:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral-412"><a href="#Mineral-412"><span class="linenos">412</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span><span class="si">}</span><span class="s2"> grain size results, and</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral-413"><a href="#Mineral-413"><span class="linenos">413</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">)</span><span class="si">}</span><span class="s2"> orientation results.&quot;</span>
</span><span id="Mineral-414"><a href="#Mineral-414"><span class="linenos">414</span></a>            <span class="p">)</span>
</span><span id="Mineral-415"><a href="#Mineral-415"><span class="linenos">415</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">:</span>
</span><span id="Mineral-416"><a href="#Mineral-416"><span class="linenos">416</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Mineral-417"><a href="#Mineral-417"><span class="linenos">417</span></a>                <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="Mineral-418"><a href="#Mineral-418"><span class="linenos">418</span></a>                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
</span><span id="Mineral-419"><a href="#Mineral-419"><span class="linenos">419</span></a>                <span class="p">),</span>
</span><span id="Mineral-420"><a href="#Mineral-420"><span class="linenos">420</span></a>                <span class="s2">&quot;fractions&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral-421"><a href="#Mineral-421"><span class="linenos">421</span></a>                <span class="s2">&quot;orientations&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">),</span>
</span><span id="Mineral-422"><a href="#Mineral-422"><span class="linenos">422</span></a>            <span class="p">}</span>
</span><span id="Mineral-423"><a href="#Mineral-423"><span class="linenos">423</span></a>            <span class="c1"># Create parent directories, resolve relative paths.</span>
</span><span id="Mineral-424"><a href="#Mineral-424"><span class="linenos">424</span></a>            <span class="n">_io</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mineral-425"><a href="#Mineral-425"><span class="linenos">425</span></a>            <span class="c1"># Append to file, requires postfix (unique name).</span>
</span><span id="Mineral-426"><a href="#Mineral-426"><span class="linenos">426</span></a>            <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral-427"><a href="#Mineral-427"><span class="linenos">427</span></a>                <span class="n">archive</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mineral-428"><a href="#Mineral-428"><span class="linenos">428</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Mineral-429"><a href="#Mineral-429"><span class="linenos">429</span></a>                    <span class="k">with</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
</span><span id="Mineral-430"><a href="#Mineral-430"><span class="linenos">430</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">force_zip64</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Mineral-431"><a href="#Mineral-431"><span class="linenos">431</span></a>                    <span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Mineral-432"><a href="#Mineral-432"><span class="linenos">432</span></a>                        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
</span><span id="Mineral-433"><a href="#Mineral-433"><span class="linenos">433</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="Mineral-434"><a href="#Mineral-434"><span class="linenos">434</span></a>                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</span><span id="Mineral-435"><a href="#Mineral-435"><span class="linenos">435</span></a>                        <span class="n">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Mineral-436"><a href="#Mineral-436"><span class="linenos">436</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-437"><a href="#Mineral-437"><span class="linenos">437</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
</span><span id="Mineral-438"><a href="#Mineral-438"><span class="linenos">438</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-439"><a href="#Mineral-439"><span class="linenos">439</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral-440"><a href="#Mineral-440"><span class="linenos">440</span></a>                <span class="s2">&quot;Size of CPO data arrays must match number of grains.&quot;</span>
</span><span id="Mineral-441"><a href="#Mineral-441"><span class="linenos">441</span></a>                <span class="o">+</span> <span class="s2">&quot; You&#39;ve supplied corrupted data with:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral-442"><a href="#Mineral-442"><span class="linenos">442</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `n_grains = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="si">}</span><span class="s2">`,</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral-443"><a href="#Mineral-443"><span class="linenos">443</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `fractions[0].shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">`, and</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral-444"><a href="#Mineral-444"><span class="linenos">444</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `orientations[0].shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">`.&quot;</span>
</span><span id="Mineral-445"><a href="#Mineral-445"><span class="linenos">445</span></a>            <span class="p">)</span>
</span><span id="Mineral-446"><a href="#Mineral-446"><span class="linenos">446</span></a>
</span><span id="Mineral-447"><a href="#Mineral-447"><span class="linenos">447</span></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mineral-448"><a href="#Mineral-448"><span class="linenos">448</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load CPO data from a `numpy` NPZ file.</span>
</span><span id="Mineral-449"><a href="#Mineral-449"><span class="linenos">449</span></a>
</span><span id="Mineral-450"><a href="#Mineral-450"><span class="linenos">450</span></a><span class="sd">        If `postfix` is not `None`, data is read from fields ending with &quot;`_postfix`&quot;.</span>
</span><span id="Mineral-451"><a href="#Mineral-451"><span class="linenos">451</span></a>
</span><span id="Mineral-452"><a href="#Mineral-452"><span class="linenos">452</span></a><span class="sd">        See also: `Mineral.save`, `Mineral.from_file`.</span>
</span><span id="Mineral-453"><a href="#Mineral-453"><span class="linenos">453</span></a>
</span><span id="Mineral-454"><a href="#Mineral-454"><span class="linenos">454</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral-455"><a href="#Mineral-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">):</span>
</span><span id="Mineral-456"><a href="#Mineral-456"><span class="linenos">456</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral-457"><a href="#Mineral-457"><span class="linenos">457</span></a>                <span class="sa">f</span><span class="s2">&quot;Must only load from numpy NPZ format. Cannot load from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Mineral-458"><a href="#Mineral-458"><span class="linenos">458</span></a>            <span class="p">)</span>
</span><span id="Mineral-459"><a href="#Mineral-459"><span class="linenos">459</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mineral-460"><a href="#Mineral-460"><span class="linenos">460</span></a>        <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral-461"><a href="#Mineral-461"><span class="linenos">461</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;meta_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="Mineral-462"><a href="#Mineral-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fractions_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral-463"><a href="#Mineral-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;orientations_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral-464"><a href="#Mineral-464"><span class="linenos">464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-465"><a href="#Mineral-465"><span class="linenos">465</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span>
</span><span id="Mineral-466"><a href="#Mineral-466"><span class="linenos">466</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fractions&quot;</span><span class="p">])</span>
</span><span id="Mineral-467"><a href="#Mineral-467"><span class="linenos">467</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">])</span>
</span><span id="Mineral-468"><a href="#Mineral-468"><span class="linenos">468</span></a>
</span><span id="Mineral-469"><a href="#Mineral-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
</span><span id="Mineral-470"><a href="#Mineral-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fabric</span> <span class="o">=</span> <span class="n">fabric</span>
</span><span id="Mineral-471"><a href="#Mineral-471"><span class="linenos">471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regime</span> <span class="o">=</span> <span class="n">regime</span>
</span><span id="Mineral-472"><a href="#Mineral-472"><span class="linenos">472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Mineral-473"><a href="#Mineral-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Mineral-474"><a href="#Mineral-474"><span class="linenos">474</span></a>
</span><span id="Mineral-475"><a href="#Mineral-475"><span class="linenos">475</span></a>    <span class="nd">@classmethod</span>
</span><span id="Mineral-476"><a href="#Mineral-476"><span class="linenos">476</span></a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mineral-477"><a href="#Mineral-477"><span class="linenos">477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a `Mineral` instance using data from a `numpy` NPZ file.</span>
</span><span id="Mineral-478"><a href="#Mineral-478"><span class="linenos">478</span></a>
</span><span id="Mineral-479"><a href="#Mineral-479"><span class="linenos">479</span></a><span class="sd">        If `postfix` is not `None`, data is read from fields ending with `_postfix`.</span>
</span><span id="Mineral-480"><a href="#Mineral-480"><span class="linenos">480</span></a>
</span><span id="Mineral-481"><a href="#Mineral-481"><span class="linenos">481</span></a><span class="sd">        See also: `Mineral.save`, `Mineral.load`.</span>
</span><span id="Mineral-482"><a href="#Mineral-482"><span class="linenos">482</span></a>
</span><span id="Mineral-483"><a href="#Mineral-483"><span class="linenos">483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral-484"><a href="#Mineral-484"><span class="linenos">484</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">):</span>
</span><span id="Mineral-485"><a href="#Mineral-485"><span class="linenos">485</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral-486"><a href="#Mineral-486"><span class="linenos">486</span></a>                <span class="sa">f</span><span class="s2">&quot;Must only load from numpy NPZ format. Cannot load from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Mineral-487"><a href="#Mineral-487"><span class="linenos">487</span></a>            <span class="p">)</span>
</span><span id="Mineral-488"><a href="#Mineral-488"><span class="linenos">488</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mineral-489"><a href="#Mineral-489"><span class="linenos">489</span></a>        <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral-490"><a href="#Mineral-490"><span class="linenos">490</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;meta_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="Mineral-491"><a href="#Mineral-491"><span class="linenos">491</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fractions_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral-492"><a href="#Mineral-492"><span class="linenos">492</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;orientations_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral-493"><a href="#Mineral-493"><span class="linenos">493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral-494"><a href="#Mineral-494"><span class="linenos">494</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span>
</span><span id="Mineral-495"><a href="#Mineral-495"><span class="linenos">495</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fractions&quot;</span><span class="p">])</span>
</span><span id="Mineral-496"><a href="#Mineral-496"><span class="linenos">496</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">])</span>
</span><span id="Mineral-497"><a href="#Mineral-497"><span class="linenos">497</span></a>
</span><span id="Mineral-498"><a href="#Mineral-498"><span class="linenos">498</span></a>        <span class="n">mineral</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Mineral-499"><a href="#Mineral-499"><span class="linenos">499</span></a>            <span class="n">phase</span><span class="p">,</span>
</span><span id="Mineral-500"><a href="#Mineral-500"><span class="linenos">500</span></a>            <span class="n">fabric</span><span class="p">,</span>
</span><span id="Mineral-501"><a href="#Mineral-501"><span class="linenos">501</span></a>            <span class="n">regime</span><span class="p">,</span>
</span><span id="Mineral-502"><a href="#Mineral-502"><span class="linenos">502</span></a>            <span class="n">n_grains</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Mineral-503"><a href="#Mineral-503"><span class="linenos">503</span></a>            <span class="n">fractions_init</span><span class="o">=</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Mineral-504"><a href="#Mineral-504"><span class="linenos">504</span></a>            <span class="n">orientations_init</span><span class="o">=</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Mineral-505"><a href="#Mineral-505"><span class="linenos">505</span></a>        <span class="p">)</span>
</span><span id="Mineral-506"><a href="#Mineral-506"><span class="linenos">506</span></a>        <span class="n">mineral</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="n">fractions</span>
</span><span id="Mineral-507"><a href="#Mineral-507"><span class="linenos">507</span></a>        <span class="n">mineral</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="n">orientations</span>
</span><span id="Mineral-508"><a href="#Mineral-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="n">mineral</span>
</span></pre></div>


            <div class="docstring"><p>Class for storing mineral CPO.</p>

<p>A <code><a href="#Mineral">Mineral</a></code> stores CPO data for an aggregate of grains*.
Additionally, mineral fabric type and deformation regime
are also tracked. See <code><a href="deformation_mechanism.html">pydrex.deformation_mechanism</a></code>.</p>

<p>Attributes:</p>

<ul>
<li><code><a href="#Mineral.phase">phase</a></code> (int)  ordinal number of the mineral phase, see <code><a href="#MineralPhase">MineralPhase</a></code></li>
<li><code><a href="#Mineral.fabric">fabric</a></code> (int)  ordinal number of the fabric type, see <code><a href="#OlivineFabric">OlivineFabric</a></code>
and <code><a href="#EnstatiteFabric">EnstatiteFabric</a></code></li>
<li><code><a href="#Mineral.regime">regime</a></code> (int)  ordinal number of the deformation regime,
see <code><a href="deformation_mechanism.html#Regime">pydrex.deformation_mechanism.Regime</a></code></li>
<li><code>n_grains</code> (int)  number of grains in the aggregate</li>
<li><code>fractions_init</code> (array, optional)  initial dimensionless grain volumes</li>
<li><code>orientations_init</code> (array, optional)  initial grain orientation matrices</li>
</ul>

<p>By default, a uniform volume distribution of random orientations is generated.</p>

<p>*Note that "grains" is here an approximate term,
and the stored objects do not fully correspond to physical grains.
For example, the number of grains is fixed despite inclusion of
grain nucleation in the modelling. It is assumed that new grains
do not grow large enough to require independent rotation tracking.
The DRex model is also unsuitable if static recrystallization is significant.</p>
</div>


                            <div id="Mineral.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Mineral</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">phase</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#MineralPhase.olivine">MineralPhase.olivine</a></span><span class="p">:</span> <span class="mi">0</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">fabric</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n"><a href="#OlivineFabric.A">OlivineFabric.A</a></span><span class="p">:</span> <span class="mi">0</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">regime</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">Regime</span><span class="o">.</span><span class="n">dislocation</span><span class="p">:</span> <span class="mi">1</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">n_grains</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>,</span><span class="param">	<span class="n">fractions_init</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">orientations_init</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">fractions</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span>,</span><span class="param">	<span class="n">orientations</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">factory</span><span class="o">&gt;</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#Mineral.__init__"></a>
    
    

                            </div>
                            <div id="Mineral.phase" class="classattr">
                                <div class="attr variable">
            <span class="name">phase</span><span class="annotation">: int</span>        =
<span class="default_value">&lt;<a href="#MineralPhase.olivine">MineralPhase.olivine</a>: 0&gt;</span>

        
    </div>
    <a class="headerlink" href="#Mineral.phase"></a>
    
    

                            </div>
                            <div id="Mineral.fabric" class="classattr">
                                <div class="attr variable">
            <span class="name">fabric</span><span class="annotation">: int</span>        =
<span class="default_value">&lt;<a href="#OlivineFabric.A">OlivineFabric.A</a>: 0&gt;</span>

        
    </div>
    <a class="headerlink" href="#Mineral.fabric"></a>
    
    

                            </div>
                            <div id="Mineral.regime" class="classattr">
                                <div class="attr variable">
            <span class="name">regime</span><span class="annotation">: int</span>        =
<span class="default_value">&lt;Regime.dislocation: 1&gt;</span>

        
    </div>
    <a class="headerlink" href="#Mineral.regime"></a>
    
    

                            </div>
                            <div id="Mineral.update_orientations" class="classattr">
                                        <input id="Mineral.update_orientations-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">update_orientations</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">config</span>,</span><span class="param">	<span class="n">deformation_gradient</span>,</span><span class="param">	<span class="n">velocity_gradient</span>,</span><span class="param">	<span class="n">integration_time</span>,</span><span class="param">	<span class="n">pathline</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mineral.update_orientations-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mineral.update_orientations"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mineral.update_orientations-190"><a href="#Mineral.update_orientations-190"><span class="linenos">190</span></a>    <span class="k">def</span> <span class="nf">update_orientations</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-191"><a href="#Mineral.update_orientations-191"><span class="linenos">191</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-192"><a href="#Mineral.update_orientations-192"><span class="linenos">192</span></a>        <span class="n">config</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-193"><a href="#Mineral.update_orientations-193"><span class="linenos">193</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-194"><a href="#Mineral.update_orientations-194"><span class="linenos">194</span></a>        <span class="n">velocity_gradient</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-195"><a href="#Mineral.update_orientations-195"><span class="linenos">195</span></a>        <span class="n">integration_time</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-196"><a href="#Mineral.update_orientations-196"><span class="linenos">196</span></a>        <span class="n">pathline</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-197"><a href="#Mineral.update_orientations-197"><span class="linenos">197</span></a>    <span class="p">):</span>
</span><span id="Mineral.update_orientations-198"><a href="#Mineral.update_orientations-198"><span class="linenos">198</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update orientations and volume distribution for the `Mineral`.</span>
</span><span id="Mineral.update_orientations-199"><a href="#Mineral.update_orientations-199"><span class="linenos">199</span></a>
</span><span id="Mineral.update_orientations-200"><a href="#Mineral.update_orientations-200"><span class="linenos">200</span></a><span class="sd">        Update crystalline orientations and grain volume distribution</span>
</span><span id="Mineral.update_orientations-201"><a href="#Mineral.update_orientations-201"><span class="linenos">201</span></a><span class="sd">        for minerals undergoing plastic deformation.</span>
</span><span id="Mineral.update_orientations-202"><a href="#Mineral.update_orientations-202"><span class="linenos">202</span></a>
</span><span id="Mineral.update_orientations-203"><a href="#Mineral.update_orientations-203"><span class="linenos">203</span></a><span class="sd">        Args:</span>
</span><span id="Mineral.update_orientations-204"><a href="#Mineral.update_orientations-204"><span class="linenos">204</span></a><span class="sd">        - `config` (dict)  PyDRex configuration dictionary</span>
</span><span id="Mineral.update_orientations-205"><a href="#Mineral.update_orientations-205"><span class="linenos">205</span></a><span class="sd">        - `deformation_gradient` (array)  3x3 initial deformation gradient tensor</span>
</span><span id="Mineral.update_orientations-206"><a href="#Mineral.update_orientations-206"><span class="linenos">206</span></a><span class="sd">        - `velocity_gradient` (array or function)  3x3 velocity gradient matrix,</span>
</span><span id="Mineral.update_orientations-207"><a href="#Mineral.update_orientations-207"><span class="linenos">207</span></a><span class="sd">          or an interpolator that returns the 3x3 matrix when evaluated at a point</span>
</span><span id="Mineral.update_orientations-208"><a href="#Mineral.update_orientations-208"><span class="linenos">208</span></a><span class="sd">          along the provided pathline</span>
</span><span id="Mineral.update_orientations-209"><a href="#Mineral.update_orientations-209"><span class="linenos">209</span></a><span class="sd">        - `integration_time` (float)  total time of integrated dislocation</span>
</span><span id="Mineral.update_orientations-210"><a href="#Mineral.update_orientations-210"><span class="linenos">210</span></a><span class="sd">          creep (if `pathline` is not None, this is used as the maximum</span>
</span><span id="Mineral.update_orientations-211"><a href="#Mineral.update_orientations-211"><span class="linenos">211</span></a><span class="sd">          integration timestep during CPO calculation)</span>
</span><span id="Mineral.update_orientations-212"><a href="#Mineral.update_orientations-212"><span class="linenos">212</span></a><span class="sd">        - `pathline` (tuple, optional)  tuple consisting of:</span>
</span><span id="Mineral.update_orientations-213"><a href="#Mineral.update_orientations-213"><span class="linenos">213</span></a><span class="sd">            1. the time at which to start the CPO integration</span>
</span><span id="Mineral.update_orientations-214"><a href="#Mineral.update_orientations-214"><span class="linenos">214</span></a><span class="sd">            2. the time at which to stop the CPO integration</span>
</span><span id="Mineral.update_orientations-215"><a href="#Mineral.update_orientations-215"><span class="linenos">215</span></a><span class="sd">            3. a callable that accepts a time value and returns the position of</span>
</span><span id="Mineral.update_orientations-216"><a href="#Mineral.update_orientations-216"><span class="linenos">216</span></a><span class="sd">               the mineral</span>
</span><span id="Mineral.update_orientations-217"><a href="#Mineral.update_orientations-217"><span class="linenos">217</span></a>
</span><span id="Mineral.update_orientations-218"><a href="#Mineral.update_orientations-218"><span class="linenos">218</span></a><span class="sd">        Array values must provide a NumPy-compatible interface:</span>
</span><span id="Mineral.update_orientations-219"><a href="#Mineral.update_orientations-219"><span class="linenos">219</span></a><span class="sd">        &lt;https://numpy.org/doc/stable/user/whatisnumpy.html&gt;</span>
</span><span id="Mineral.update_orientations-220"><a href="#Mineral.update_orientations-220"><span class="linenos">220</span></a>
</span><span id="Mineral.update_orientations-221"><a href="#Mineral.update_orientations-221"><span class="linenos">221</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral.update_orientations-222"><a href="#Mineral.update_orientations-222"><span class="linenos">222</span></a>
</span><span id="Mineral.update_orientations-223"><a href="#Mineral.update_orientations-223"><span class="linenos">223</span></a>        <span class="c1"># Set up callables for the ODE, some variables come from enclosing scope.</span>
</span><span id="Mineral.update_orientations-224"><a href="#Mineral.update_orientations-224"><span class="linenos">224</span></a>        <span class="k">def</span> <span class="nf">extract_vars</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
</span><span id="Mineral.update_orientations-225"><a href="#Mineral.update_orientations-225"><span class="linenos">225</span></a>            <span class="c1"># TODO: Check if we can avoid .copy() here.</span>
</span><span id="Mineral.update_orientations-226"><a href="#Mineral.update_orientations-226"><span class="linenos">226</span></a>            <span class="n">deformation_gradient</span> <span class="o">=</span> <span class="n">y</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-227"><a href="#Mineral.update_orientations-227"><span class="linenos">227</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mineral.update_orientations-228"><a href="#Mineral.update_orientations-228"><span class="linenos">228</span></a>                <span class="n">y</span><span class="p">[</span><span class="mi">9</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span>
</span><span id="Mineral.update_orientations-229"><a href="#Mineral.update_orientations-229"><span class="linenos">229</span></a>                <span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Mineral.update_orientations-230"><a href="#Mineral.update_orientations-230"><span class="linenos">230</span></a>                <span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-231"><a href="#Mineral.update_orientations-231"><span class="linenos">231</span></a>                <span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-232"><a href="#Mineral.update_orientations-232"><span class="linenos">232</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-233"><a href="#Mineral.update_orientations-233"><span class="linenos">233</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="Mineral.update_orientations-234"><a href="#Mineral.update_orientations-234"><span class="linenos">234</span></a>                <span class="n">y</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">+</span> <span class="mi">9</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-235"><a href="#Mineral.update_orientations-235"><span class="linenos">235</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-236"><a href="#Mineral.update_orientations-236"><span class="linenos">236</span></a>            <span class="c1"># FIXME: Guard against zero-division? Why is .sum  0?</span>
</span><span id="Mineral.update_orientations-237"><a href="#Mineral.update_orientations-237"><span class="linenos">237</span></a>            <span class="n">fractions</span> <span class="o">/=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Mineral.update_orientations-238"><a href="#Mineral.update_orientations-238"><span class="linenos">238</span></a>            <span class="k">return</span> <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span>
</span><span id="Mineral.update_orientations-239"><a href="#Mineral.update_orientations-239"><span class="linenos">239</span></a>
</span><span id="Mineral.update_orientations-240"><a href="#Mineral.update_orientations-240"><span class="linenos">240</span></a>        <span class="k">def</span> <span class="nf">eval_rhs</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
</span><span id="Mineral.update_orientations-241"><a href="#Mineral.update_orientations-241"><span class="linenos">241</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Evaluate right hand side of the D-Rex PDE.&quot;&quot;&quot;</span>
</span><span id="Mineral.update_orientations-242"><a href="#Mineral.update_orientations-242"><span class="linenos">242</span></a>            <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-243"><a href="#Mineral.update_orientations-243"><span class="linenos">243</span></a>            <span class="c1"># Uses nondimensional values of strain rate and velocity gradient.</span>
</span><span id="Mineral.update_orientations-244"><a href="#Mineral.update_orientations-244"><span class="linenos">244</span></a>            <span class="n">orientations_diff</span><span class="p">,</span> <span class="n">fractions_diff</span> <span class="o">=</span> <span class="n">_core</span><span class="o">.</span><span class="n">derivatives</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-245"><a href="#Mineral.update_orientations-245"><span class="linenos">245</span></a>                <span class="n">phase</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-246"><a href="#Mineral.update_orientations-246"><span class="linenos">246</span></a>                <span class="n">fabric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-247"><a href="#Mineral.update_orientations-247"><span class="linenos">247</span></a>                <span class="n">n_grains</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-248"><a href="#Mineral.update_orientations-248"><span class="linenos">248</span></a>                <span class="n">orientations</span><span class="o">=</span><span class="n">orientations</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-249"><a href="#Mineral.update_orientations-249"><span class="linenos">249</span></a>                <span class="n">fractions</span><span class="o">=</span><span class="n">fractions</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-250"><a href="#Mineral.update_orientations-250"><span class="linenos">250</span></a>                <span class="n">strain_rate</span><span class="o">=</span><span class="n">strain_rate</span> <span class="o">/</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-251"><a href="#Mineral.update_orientations-251"><span class="linenos">251</span></a>                <span class="n">velocity_gradient</span><span class="o">=</span><span class="n">_velocity_gradient</span> <span class="o">/</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-252"><a href="#Mineral.update_orientations-252"><span class="linenos">252</span></a>                <span class="n">stress_exponent</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;stress_exponent&quot;</span><span class="p">],</span>
</span><span id="Mineral.update_orientations-253"><a href="#Mineral.update_orientations-253"><span class="linenos">253</span></a>                <span class="n">deformation_exponent</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;deformation_exponent&quot;</span><span class="p">],</span>
</span><span id="Mineral.update_orientations-254"><a href="#Mineral.update_orientations-254"><span class="linenos">254</span></a>                <span class="n">nucleation_efficiency</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;nucleation_efficiency&quot;</span><span class="p">],</span>
</span><span id="Mineral.update_orientations-255"><a href="#Mineral.update_orientations-255"><span class="linenos">255</span></a>                <span class="n">gbm_mobility</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbm_mobility&quot;</span><span class="p">],</span>
</span><span id="Mineral.update_orientations-256"><a href="#Mineral.update_orientations-256"><span class="linenos">256</span></a>                <span class="n">volume_fraction</span><span class="o">=</span><span class="n">volume_fraction</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-257"><a href="#Mineral.update_orientations-257"><span class="linenos">257</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-258"><a href="#Mineral.update_orientations-258"><span class="linenos">258</span></a>            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-259"><a href="#Mineral.update_orientations-259"><span class="linenos">259</span></a>                <span class="p">(</span>
</span><span id="Mineral.update_orientations-260"><a href="#Mineral.update_orientations-260"><span class="linenos">260</span></a>                    <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">@</span> <span class="n">deformation_gradient</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral.update_orientations-261"><a href="#Mineral.update_orientations-261"><span class="linenos">261</span></a>                    <span class="n">orientations_diff</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="o">*</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-262"><a href="#Mineral.update_orientations-262"><span class="linenos">262</span></a>                    <span class="n">fractions_diff</span> <span class="o">*</span> <span class="n">strain_rate_max</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-263"><a href="#Mineral.update_orientations-263"><span class="linenos">263</span></a>                <span class="p">)</span>
</span><span id="Mineral.update_orientations-264"><a href="#Mineral.update_orientations-264"><span class="linenos">264</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-265"><a href="#Mineral.update_orientations-265"><span class="linenos">265</span></a>
</span><span id="Mineral.update_orientations-266"><a href="#Mineral.update_orientations-266"><span class="linenos">266</span></a>        <span class="k">def</span> <span class="nf">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
</span><span id="Mineral.update_orientations-267"><a href="#Mineral.update_orientations-267"><span class="linenos">267</span></a>            <span class="c1"># Grain boundary sliding for small grains.</span>
</span><span id="Mineral.update_orientations-268"><a href="#Mineral.update_orientations-268"><span class="linenos">268</span></a>            <span class="n">mask</span> <span class="o">=</span> <span class="n">fractions</span> <span class="o">&lt;</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbs_threshold&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span>
</span><span id="Mineral.update_orientations-269"><a href="#Mineral.update_orientations-269"><span class="linenos">269</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-270"><a href="#Mineral.update_orientations-270"><span class="linenos">270</span></a>                <span class="s2">&quot;grain boundary sliding activity (volume percentage): </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-271"><a href="#Mineral.update_orientations-271"><span class="linenos">271</span></a>                <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral.update_orientations-272"><a href="#Mineral.update_orientations-272"><span class="linenos">272</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-273"><a href="#Mineral.update_orientations-273"><span class="linenos">273</span></a>            <span class="c1"># No rotation: carry over previous orientations.</span>
</span><span id="Mineral.update_orientations-274"><a href="#Mineral.update_orientations-274"><span class="linenos">274</span></a>            <span class="n">orientations</span><span class="p">[</span><span class="n">mask</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mask</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
</span><span id="Mineral.update_orientations-275"><a href="#Mineral.update_orientations-275"><span class="linenos">275</span></a>            <span class="n">fractions</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;gbs_threshold&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span>
</span><span id="Mineral.update_orientations-276"><a href="#Mineral.update_orientations-276"><span class="linenos">276</span></a>            <span class="c1"># FIXME: Guard against zero-division? Why is .sum  0?</span>
</span><span id="Mineral.update_orientations-277"><a href="#Mineral.update_orientations-277"><span class="linenos">277</span></a>            <span class="n">fractions</span> <span class="o">/=</span> <span class="n">fractions</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="Mineral.update_orientations-278"><a href="#Mineral.update_orientations-278"><span class="linenos">278</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-279"><a href="#Mineral.update_orientations-279"><span class="linenos">279</span></a>                <span class="s2">&quot;grain volume fractions: median=</span><span class="si">%e</span><span class="s2">, min=</span><span class="si">%e</span><span class="s2">, max=</span><span class="si">%e</span><span class="s2">, sum=</span><span class="si">%e</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-280"><a href="#Mineral.update_orientations-280"><span class="linenos">280</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral.update_orientations-281"><a href="#Mineral.update_orientations-281"><span class="linenos">281</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral.update_orientations-282"><a href="#Mineral.update_orientations-282"><span class="linenos">282</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral.update_orientations-283"><a href="#Mineral.update_orientations-283"><span class="linenos">283</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral.update_orientations-284"><a href="#Mineral.update_orientations-284"><span class="linenos">284</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-285"><a href="#Mineral.update_orientations-285"><span class="linenos">285</span></a>            <span class="k">return</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span>
</span><span id="Mineral.update_orientations-286"><a href="#Mineral.update_orientations-286"><span class="linenos">286</span></a>
</span><span id="Mineral.update_orientations-287"><a href="#Mineral.update_orientations-287"><span class="linenos">287</span></a>        <span class="c1"># Set up pathline or time integral bounds and initial condition.</span>
</span><span id="Mineral.update_orientations-288"><a href="#Mineral.update_orientations-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">velocity_gradient</span><span class="p">):</span>
</span><span id="Mineral.update_orientations-289"><a href="#Mineral.update_orientations-289"><span class="linenos">289</span></a>            <span class="k">if</span> <span class="n">pathline</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-290"><a href="#Mineral.update_orientations-290"><span class="linenos">290</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-291"><a href="#Mineral.update_orientations-291"><span class="linenos">291</span></a>                    <span class="s2">&quot;unable to evaluate velocity gradient callable.&quot;</span>
</span><span id="Mineral.update_orientations-292"><a href="#Mineral.update_orientations-292"><span class="linenos">292</span></a>                    <span class="o">+</span> <span class="s2">&quot; You must provide the `pathline` to use a velocity gradient callable.&quot;</span>
</span><span id="Mineral.update_orientations-293"><a href="#Mineral.update_orientations-293"><span class="linenos">293</span></a>                <span class="p">)</span>
</span><span id="Mineral.update_orientations-294"><a href="#Mineral.update_orientations-294"><span class="linenos">294</span></a>            <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="n">get_position</span> <span class="o">=</span> <span class="n">pathline</span>
</span><span id="Mineral.update_orientations-295"><a href="#Mineral.update_orientations-295"><span class="linenos">295</span></a>            <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-296"><a href="#Mineral.update_orientations-296"><span class="linenos">296</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">get_position</span><span class="p">(</span><span class="n">time_start</span><span class="p">))</span>
</span><span id="Mineral.update_orientations-297"><a href="#Mineral.update_orientations-297"><span class="linenos">297</span></a>            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Mineral.update_orientations-298"><a href="#Mineral.update_orientations-298"><span class="linenos">298</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-299"><a href="#Mineral.update_orientations-299"><span class="linenos">299</span></a>                <span class="s2">&quot;calculating CPO at </span><span class="si">%s</span><span class="s2"> (t=</span><span class="si">%e</span><span class="s2">) with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-300"><a href="#Mineral.update_orientations-300"><span class="linenos">300</span></a>                <span class="n">get_position</span><span class="p">(</span><span class="n">time_start</span><span class="p">),</span>
</span><span id="Mineral.update_orientations-301"><a href="#Mineral.update_orientations-301"><span class="linenos">301</span></a>                <span class="n">time_start</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-302"><a href="#Mineral.update_orientations-302"><span class="linenos">302</span></a>                <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral.update_orientations-303"><a href="#Mineral.update_orientations-303"><span class="linenos">303</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-304"><a href="#Mineral.update_orientations-304"><span class="linenos">304</span></a>            <span class="n">max_step</span> <span class="o">=</span> <span class="n">integration_time</span>
</span><span id="Mineral.update_orientations-305"><a href="#Mineral.update_orientations-305"><span class="linenos">305</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-306"><a href="#Mineral.update_orientations-306"><span class="linenos">306</span></a>            <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span>
</span><span id="Mineral.update_orientations-307"><a href="#Mineral.update_orientations-307"><span class="linenos">307</span></a>            <span class="n">time_start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="Mineral.update_orientations-308"><a href="#Mineral.update_orientations-308"><span class="linenos">308</span></a>            <span class="n">time_end</span> <span class="o">=</span> <span class="n">integration_time</span>
</span><span id="Mineral.update_orientations-309"><a href="#Mineral.update_orientations-309"><span class="linenos">309</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-310"><a href="#Mineral.update_orientations-310"><span class="linenos">310</span></a>                <span class="s2">&quot;calculating CPO for t=</span><span class="si">%e</span><span class="s2"> with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-311"><a href="#Mineral.update_orientations-311"><span class="linenos">311</span></a>                <span class="n">time_end</span> <span class="o">-</span> <span class="n">time_start</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-312"><a href="#Mineral.update_orientations-312"><span class="linenos">312</span></a>                <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral.update_orientations-313"><a href="#Mineral.update_orientations-313"><span class="linenos">313</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-314"><a href="#Mineral.update_orientations-314"><span class="linenos">314</span></a>            <span class="n">max_step</span> <span class="o">=</span> <span class="n">time_end</span> <span class="o">-</span> <span class="n">time_start</span>
</span><span id="Mineral.update_orientations-315"><a href="#Mineral.update_orientations-315"><span class="linenos">315</span></a>
</span><span id="Mineral.update_orientations-316"><a href="#Mineral.update_orientations-316"><span class="linenos">316</span></a>        <span class="n">strain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">+</span> <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="Mineral.update_orientations-317"><a href="#Mineral.update_orientations-317"><span class="linenos">317</span></a>        <span class="n">strain_rate_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">strain_rate</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="Mineral.update_orientations-318"><a href="#Mineral.update_orientations-318"><span class="linenos">318</span></a>        <span class="c1"># max_step = min(max_step, 1e-2 / strain_rate_max)</span>
</span><span id="Mineral.update_orientations-319"><a href="#Mineral.update_orientations-319"><span class="linenos">319</span></a>        <span class="c1"># max_step = 1e6</span>
</span><span id="Mineral.update_orientations-320"><a href="#Mineral.update_orientations-320"><span class="linenos">320</span></a>
</span><span id="Mineral.update_orientations-321"><a href="#Mineral.update_orientations-321"><span class="linenos">321</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">olivine</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-322"><a href="#Mineral.update_orientations-322"><span class="linenos">322</span></a>            <span class="n">volume_fraction</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;olivine_fraction&quot;</span><span class="p">]</span>
</span><span id="Mineral.update_orientations-323"><a href="#Mineral.update_orientations-323"><span class="linenos">323</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">==</span> <span class="n">MineralPhase</span><span class="o">.</span><span class="n">enstatite</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-324"><a href="#Mineral.update_orientations-324"><span class="linenos">324</span></a>            <span class="n">volume_fraction</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;enstatite_fraction&quot;</span><span class="p">]</span>
</span><span id="Mineral.update_orientations-325"><a href="#Mineral.update_orientations-325"><span class="linenos">325</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-326"><a href="#Mineral.update_orientations-326"><span class="linenos">326</span></a>            <span class="k">assert</span> <span class="kc">False</span>  <span class="c1"># Should never happen.</span>
</span><span id="Mineral.update_orientations-327"><a href="#Mineral.update_orientations-327"><span class="linenos">327</span></a>
</span><span id="Mineral.update_orientations-328"><a href="#Mineral.update_orientations-328"><span class="linenos">328</span></a>        <span class="c1"># Initialise solver and perform first step.</span>
</span><span id="Mineral.update_orientations-329"><a href="#Mineral.update_orientations-329"><span class="linenos">329</span></a>        <span class="n">solver</span> <span class="o">=</span> <span class="n">RK45</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-330"><a href="#Mineral.update_orientations-330"><span class="linenos">330</span></a>            <span class="n">eval_rhs</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-331"><a href="#Mineral.update_orientations-331"><span class="linenos">331</span></a>            <span class="n">time_start</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-332"><a href="#Mineral.update_orientations-332"><span class="linenos">332</span></a>            <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-333"><a href="#Mineral.update_orientations-333"><span class="linenos">333</span></a>                <span class="p">(</span>
</span><span id="Mineral.update_orientations-334"><a href="#Mineral.update_orientations-334"><span class="linenos">334</span></a>                    <span class="n">deformation_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral.update_orientations-335"><a href="#Mineral.update_orientations-335"><span class="linenos">335</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral.update_orientations-336"><a href="#Mineral.update_orientations-336"><span class="linenos">336</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
</span><span id="Mineral.update_orientations-337"><a href="#Mineral.update_orientations-337"><span class="linenos">337</span></a>                <span class="p">)</span>
</span><span id="Mineral.update_orientations-338"><a href="#Mineral.update_orientations-338"><span class="linenos">338</span></a>            <span class="p">),</span>
</span><span id="Mineral.update_orientations-339"><a href="#Mineral.update_orientations-339"><span class="linenos">339</span></a>            <span class="n">time_end</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-340"><a href="#Mineral.update_orientations-340"><span class="linenos">340</span></a>            <span class="c1"># first_step=max_step / 4,  # TODO: Move divisor to config?</span>
</span><span id="Mineral.update_orientations-341"><a href="#Mineral.update_orientations-341"><span class="linenos">341</span></a>            <span class="n">max_step</span><span class="o">=</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-342"><a href="#Mineral.update_orientations-342"><span class="linenos">342</span></a>            <span class="c1"># atol=np.inf,  # FIXME: Different solver or smart way to set tolerance.</span>
</span><span id="Mineral.update_orientations-343"><a href="#Mineral.update_orientations-343"><span class="linenos">343</span></a>        <span class="p">)</span>
</span><span id="Mineral.update_orientations-344"><a href="#Mineral.update_orientations-344"><span class="linenos">344</span></a>        <span class="n">message</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="Mineral.update_orientations-345"><a href="#Mineral.update_orientations-345"><span class="linenos">345</span></a>        <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-346"><a href="#Mineral.update_orientations-346"><span class="linenos">346</span></a>            <span class="k">raise</span> <span class="n">_err</span><span class="o">.</span><span class="n">IterationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-347"><a href="#Mineral.update_orientations-347"><span class="linenos">347</span></a>        <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-348"><a href="#Mineral.update_orientations-348"><span class="linenos">348</span></a>            <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> step_size=</span><span class="si">%e</span><span class="s2"> (max_step=</span><span class="si">%e</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-349"><a href="#Mineral.update_orientations-349"><span class="linenos">349</span></a>            <span class="n">solver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-350"><a href="#Mineral.update_orientations-350"><span class="linenos">350</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-351"><a href="#Mineral.update_orientations-351"><span class="linenos">351</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-352"><a href="#Mineral.update_orientations-352"><span class="linenos">352</span></a>        <span class="p">)</span>
</span><span id="Mineral.update_orientations-353"><a href="#Mineral.update_orientations-353"><span class="linenos">353</span></a>
</span><span id="Mineral.update_orientations-354"><a href="#Mineral.update_orientations-354"><span class="linenos">354</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-355"><a href="#Mineral.update_orientations-355"><span class="linenos">355</span></a>        <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-356"><a href="#Mineral.update_orientations-356"><span class="linenos">356</span></a>        <span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">orientations</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fractions</span><span class="p">))</span>
</span><span id="Mineral.update_orientations-357"><a href="#Mineral.update_orientations-357"><span class="linenos">357</span></a>
</span><span id="Mineral.update_orientations-358"><a href="#Mineral.update_orientations-358"><span class="linenos">358</span></a>        <span class="c1"># Solve ODE using numerical iteration scheme.</span>
</span><span id="Mineral.update_orientations-359"><a href="#Mineral.update_orientations-359"><span class="linenos">359</span></a>        <span class="k">while</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;running&quot;</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-360"><a href="#Mineral.update_orientations-360"><span class="linenos">360</span></a>            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">velocity_gradient</span><span class="p">):</span>
</span><span id="Mineral.update_orientations-361"><a href="#Mineral.update_orientations-361"><span class="linenos">361</span></a>                <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-362"><a href="#Mineral.update_orientations-362"><span class="linenos">362</span></a>                    <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">get_position</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">))</span>
</span><span id="Mineral.update_orientations-363"><a href="#Mineral.update_orientations-363"><span class="linenos">363</span></a>                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Mineral.update_orientations-364"><a href="#Mineral.update_orientations-364"><span class="linenos">364</span></a>                <span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-365"><a href="#Mineral.update_orientations-365"><span class="linenos">365</span></a>                    <span class="s2">&quot;calculating CPO at </span><span class="si">%s</span><span class="s2"> (t=</span><span class="si">%e</span><span class="s2">) with velocity gradient </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-366"><a href="#Mineral.update_orientations-366"><span class="linenos">366</span></a>                    <span class="n">get_position</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">),</span>
</span><span id="Mineral.update_orientations-367"><a href="#Mineral.update_orientations-367"><span class="linenos">367</span></a>                    <span class="n">solver</span><span class="o">.</span><span class="n">t</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-368"><a href="#Mineral.update_orientations-368"><span class="linenos">368</span></a>                    <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span>
</span><span id="Mineral.update_orientations-369"><a href="#Mineral.update_orientations-369"><span class="linenos">369</span></a>                <span class="p">)</span>
</span><span id="Mineral.update_orientations-370"><a href="#Mineral.update_orientations-370"><span class="linenos">370</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-371"><a href="#Mineral.update_orientations-371"><span class="linenos">371</span></a>                <span class="n">_velocity_gradient</span> <span class="o">=</span> <span class="n">velocity_gradient</span>
</span><span id="Mineral.update_orientations-372"><a href="#Mineral.update_orientations-372"><span class="linenos">372</span></a>
</span><span id="Mineral.update_orientations-373"><a href="#Mineral.update_orientations-373"><span class="linenos">373</span></a>            <span class="n">strain_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">_velocity_gradient</span> <span class="o">+</span> <span class="n">_velocity_gradient</span><span class="o">.</span><span class="n">transpose</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="Mineral.update_orientations-374"><a href="#Mineral.update_orientations-374"><span class="linenos">374</span></a>            <span class="n">strain_rate_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">eigvalsh</span><span class="p">(</span><span class="n">strain_rate</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</span><span id="Mineral.update_orientations-375"><a href="#Mineral.update_orientations-375"><span class="linenos">375</span></a>            <span class="c1"># solver.max_step = min(solver.max_step, 1e-2 / strain_rate_max)</span>
</span><span id="Mineral.update_orientations-376"><a href="#Mineral.update_orientations-376"><span class="linenos">376</span></a>
</span><span id="Mineral.update_orientations-377"><a href="#Mineral.update_orientations-377"><span class="linenos">377</span></a>            <span class="n">message</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
</span><span id="Mineral.update_orientations-378"><a href="#Mineral.update_orientations-378"><span class="linenos">378</span></a>            <span class="k">if</span> <span class="n">message</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">solver</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
</span><span id="Mineral.update_orientations-379"><a href="#Mineral.update_orientations-379"><span class="linenos">379</span></a>                <span class="k">raise</span> <span class="n">_err</span><span class="o">.</span><span class="n">IterationError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-380"><a href="#Mineral.update_orientations-380"><span class="linenos">380</span></a>            <span class="n">_log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
</span><span id="Mineral.update_orientations-381"><a href="#Mineral.update_orientations-381"><span class="linenos">381</span></a>                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> step_size=</span><span class="si">%e</span><span class="s2"> (max_step=</span><span class="si">%e</span><span class="s2">)&quot;</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-382"><a href="#Mineral.update_orientations-382"><span class="linenos">382</span></a>                <span class="n">solver</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__qualname__</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-383"><a href="#Mineral.update_orientations-383"><span class="linenos">383</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">step_size</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-384"><a href="#Mineral.update_orientations-384"><span class="linenos">384</span></a>                <span class="n">solver</span><span class="o">.</span><span class="n">max_step</span><span class="p">,</span>
</span><span id="Mineral.update_orientations-385"><a href="#Mineral.update_orientations-385"><span class="linenos">385</span></a>            <span class="p">)</span>
</span><span id="Mineral.update_orientations-386"><a href="#Mineral.update_orientations-386"><span class="linenos">386</span></a>
</span><span id="Mineral.update_orientations-387"><a href="#Mineral.update_orientations-387"><span class="linenos">387</span></a>            <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-388"><a href="#Mineral.update_orientations-388"><span class="linenos">388</span></a>            <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">apply_gbs</span><span class="p">(</span><span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-389"><a href="#Mineral.update_orientations-389"><span class="linenos">389</span></a>            <span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">orientations</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">fractions</span><span class="p">))</span>
</span><span id="Mineral.update_orientations-390"><a href="#Mineral.update_orientations-390"><span class="linenos">390</span></a>
</span><span id="Mineral.update_orientations-391"><a href="#Mineral.update_orientations-391"><span class="linenos">391</span></a>        <span class="c1"># Extract final values for this simulation step, append to storage.</span>
</span><span id="Mineral.update_orientations-392"><a href="#Mineral.update_orientations-392"><span class="linenos">392</span></a>        <span class="n">deformation_gradient</span><span class="p">,</span> <span class="n">orientations</span><span class="p">,</span> <span class="n">fractions</span> <span class="o">=</span> <span class="n">extract_vars</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">squeeze</span><span class="p">())</span>
</span><span id="Mineral.update_orientations-393"><a href="#Mineral.update_orientations-393"><span class="linenos">393</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">orientations</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-394"><a href="#Mineral.update_orientations-394"><span class="linenos">394</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fractions</span><span class="p">)</span>
</span><span id="Mineral.update_orientations-395"><a href="#Mineral.update_orientations-395"><span class="linenos">395</span></a>        <span class="k">return</span> <span class="n">deformation_gradient</span>
</span></pre></div>


            <div class="docstring"><p>Update orientations and volume distribution for the <code><a href="#Mineral">Mineral</a></code>.</p>

<p>Update crystalline orientations and grain volume distribution
for minerals undergoing plastic deformation.</p>

<p>Args:</p>

<ul>
<li><code>config</code> (dict)  PyDRex configuration dictionary</li>
<li><code>deformation_gradient</code> (array)  3x3 initial deformation gradient tensor</li>
<li><code>velocity_gradient</code> (array or function)  3x3 velocity gradient matrix,
or an interpolator that returns the 3x3 matrix when evaluated at a point
along the provided pathline</li>
<li><code>integration_time</code> (float)  total time of integrated dislocation
creep (if <code>pathline</code> is not None, this is used as the maximum
integration timestep during CPO calculation)</li>
<li><code>pathline</code> (tuple, optional)  tuple consisting of:
<ol>
<li>the time at which to start the CPO integration</li>
<li>the time at which to stop the CPO integration</li>
<li>a callable that accepts a time value and returns the position of
the mineral</li>
</ol></li>
</ul>

<p>Array values must provide a NumPy-compatible interface:
<a href="https://numpy.org/doc/stable/user/whatisnumpy.html">https://numpy.org/doc/stable/user/whatisnumpy.html</a></p>
</div>


                            </div>
                            <div id="Mineral.save" class="classattr">
                                        <input id="Mineral.save-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filename</span>, </span><span class="param"><span class="n">postfix</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mineral.save-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mineral.save"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mineral.save-397"><a href="#Mineral.save-397"><span class="linenos">397</span></a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mineral.save-398"><a href="#Mineral.save-398"><span class="linenos">398</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save CPO data for all stored timesteps to a `numpy` NPZ file.</span>
</span><span id="Mineral.save-399"><a href="#Mineral.save-399"><span class="linenos">399</span></a>
</span><span id="Mineral.save-400"><a href="#Mineral.save-400"><span class="linenos">400</span></a><span class="sd">        If `postfix` is not `None`, the data is appended to the NPZ file</span>
</span><span id="Mineral.save-401"><a href="#Mineral.save-401"><span class="linenos">401</span></a><span class="sd">        in fields ending with &quot;`_postfix`&quot;.</span>
</span><span id="Mineral.save-402"><a href="#Mineral.save-402"><span class="linenos">402</span></a>
</span><span id="Mineral.save-403"><a href="#Mineral.save-403"><span class="linenos">403</span></a><span class="sd">        Raises a `ValueError` if the data shapes are not compatible.</span>
</span><span id="Mineral.save-404"><a href="#Mineral.save-404"><span class="linenos">404</span></a>
</span><span id="Mineral.save-405"><a href="#Mineral.save-405"><span class="linenos">405</span></a><span class="sd">        See also: `numpy.savez`, `Mineral.load`, `Mineral.from_file`.</span>
</span><span id="Mineral.save-406"><a href="#Mineral.save-406"><span class="linenos">406</span></a>
</span><span id="Mineral.save-407"><a href="#Mineral.save-407"><span class="linenos">407</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral.save-408"><a href="#Mineral.save-408"><span class="linenos">408</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">):</span>
</span><span id="Mineral.save-409"><a href="#Mineral.save-409"><span class="linenos">409</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral.save-410"><a href="#Mineral.save-410"><span class="linenos">410</span></a>                <span class="s2">&quot;Length of stored results must match.&quot;</span>
</span><span id="Mineral.save-411"><a href="#Mineral.save-411"><span class="linenos">411</span></a>                <span class="o">+</span> <span class="s2">&quot; You&#39;ve supplied currupted data with:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral.save-412"><a href="#Mineral.save-412"><span class="linenos">412</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">)</span><span class="si">}</span><span class="s2"> grain size results, and</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral.save-413"><a href="#Mineral.save-413"><span class="linenos">413</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">)</span><span class="si">}</span><span class="s2"> orientation results.&quot;</span>
</span><span id="Mineral.save-414"><a href="#Mineral.save-414"><span class="linenos">414</span></a>            <span class="p">)</span>
</span><span id="Mineral.save-415"><a href="#Mineral.save-415"><span class="linenos">415</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="p">:</span>
</span><span id="Mineral.save-416"><a href="#Mineral.save-416"><span class="linenos">416</span></a>            <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Mineral.save-417"><a href="#Mineral.save-417"><span class="linenos">417</span></a>                <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="Mineral.save-418"><a href="#Mineral.save-418"><span class="linenos">418</span></a>                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fabric</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">regime</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
</span><span id="Mineral.save-419"><a href="#Mineral.save-419"><span class="linenos">419</span></a>                <span class="p">),</span>
</span><span id="Mineral.save-420"><a href="#Mineral.save-420"><span class="linenos">420</span></a>                <span class="s2">&quot;fractions&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">),</span>
</span><span id="Mineral.save-421"><a href="#Mineral.save-421"><span class="linenos">421</span></a>                <span class="s2">&quot;orientations&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">),</span>
</span><span id="Mineral.save-422"><a href="#Mineral.save-422"><span class="linenos">422</span></a>            <span class="p">}</span>
</span><span id="Mineral.save-423"><a href="#Mineral.save-423"><span class="linenos">423</span></a>            <span class="c1"># Create parent directories, resolve relative paths.</span>
</span><span id="Mineral.save-424"><a href="#Mineral.save-424"><span class="linenos">424</span></a>            <span class="n">_io</span><span class="o">.</span><span class="n">resolve_path</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mineral.save-425"><a href="#Mineral.save-425"><span class="linenos">425</span></a>            <span class="c1"># Append to file, requires postfix (unique name).</span>
</span><span id="Mineral.save-426"><a href="#Mineral.save-426"><span class="linenos">426</span></a>            <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral.save-427"><a href="#Mineral.save-427"><span class="linenos">427</span></a>                <span class="n">archive</span> <span class="o">=</span> <span class="n">ZipFile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">allowZip64</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="Mineral.save-428"><a href="#Mineral.save-428"><span class="linenos">428</span></a>                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="Mineral.save-429"><a href="#Mineral.save-429"><span class="linenos">429</span></a>                    <span class="k">with</span> <span class="n">archive</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
</span><span id="Mineral.save-430"><a href="#Mineral.save-430"><span class="linenos">430</span></a>                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">force_zip64</span><span class="o">=</span><span class="kc">True</span>
</span><span id="Mineral.save-431"><a href="#Mineral.save-431"><span class="linenos">431</span></a>                    <span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Mineral.save-432"><a href="#Mineral.save-432"><span class="linenos">432</span></a>                        <span class="n">buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">()</span>
</span><span id="Mineral.save-433"><a href="#Mineral.save-433"><span class="linenos">433</span></a>                        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
</span><span id="Mineral.save-434"><a href="#Mineral.save-434"><span class="linenos">434</span></a>                        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
</span><span id="Mineral.save-435"><a href="#Mineral.save-435"><span class="linenos">435</span></a>                        <span class="n">buffer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span id="Mineral.save-436"><a href="#Mineral.save-436"><span class="linenos">436</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral.save-437"><a href="#Mineral.save-437"><span class="linenos">437</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">savez</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
</span><span id="Mineral.save-438"><a href="#Mineral.save-438"><span class="linenos">438</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral.save-439"><a href="#Mineral.save-439"><span class="linenos">439</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral.save-440"><a href="#Mineral.save-440"><span class="linenos">440</span></a>                <span class="s2">&quot;Size of CPO data arrays must match number of grains.&quot;</span>
</span><span id="Mineral.save-441"><a href="#Mineral.save-441"><span class="linenos">441</span></a>                <span class="o">+</span> <span class="s2">&quot; You&#39;ve supplied corrupted data with:</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral.save-442"><a href="#Mineral.save-442"><span class="linenos">442</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `n_grains = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_grains</span><span class="si">}</span><span class="s2">`,</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral.save-443"><a href="#Mineral.save-443"><span class="linenos">443</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `fractions[0].shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">`, and</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="Mineral.save-444"><a href="#Mineral.save-444"><span class="linenos">444</span></a>                <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;- `orientations[0].shape = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">`.&quot;</span>
</span><span id="Mineral.save-445"><a href="#Mineral.save-445"><span class="linenos">445</span></a>            <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save CPO data for all stored timesteps to a <code>numpy</code> NPZ file.</p>

<p>If <code>postfix</code> is not <code>None</code>, the data is appended to the NPZ file
in fields ending with "<code>_postfix</code>".</p>

<p>Raises a <code>ValueError</code> if the data shapes are not compatible.</p>

<p>See also: <code>numpy.savez</code>, <code><a href="#Mineral.load">Mineral.load</a></code>, <code><a href="#Mineral.from_file">Mineral.from_file</a></code>.</p>
</div>


                            </div>
                            <div id="Mineral.load" class="classattr">
                                        <input id="Mineral.load-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">load</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">filename</span>, </span><span class="param"><span class="n">postfix</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mineral.load-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mineral.load"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mineral.load-447"><a href="#Mineral.load-447"><span class="linenos">447</span></a>    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mineral.load-448"><a href="#Mineral.load-448"><span class="linenos">448</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Load CPO data from a `numpy` NPZ file.</span>
</span><span id="Mineral.load-449"><a href="#Mineral.load-449"><span class="linenos">449</span></a>
</span><span id="Mineral.load-450"><a href="#Mineral.load-450"><span class="linenos">450</span></a><span class="sd">        If `postfix` is not `None`, data is read from fields ending with &quot;`_postfix`&quot;.</span>
</span><span id="Mineral.load-451"><a href="#Mineral.load-451"><span class="linenos">451</span></a>
</span><span id="Mineral.load-452"><a href="#Mineral.load-452"><span class="linenos">452</span></a><span class="sd">        See also: `Mineral.save`, `Mineral.from_file`.</span>
</span><span id="Mineral.load-453"><a href="#Mineral.load-453"><span class="linenos">453</span></a>
</span><span id="Mineral.load-454"><a href="#Mineral.load-454"><span class="linenos">454</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral.load-455"><a href="#Mineral.load-455"><span class="linenos">455</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">):</span>
</span><span id="Mineral.load-456"><a href="#Mineral.load-456"><span class="linenos">456</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral.load-457"><a href="#Mineral.load-457"><span class="linenos">457</span></a>                <span class="sa">f</span><span class="s2">&quot;Must only load from numpy NPZ format. Cannot load from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Mineral.load-458"><a href="#Mineral.load-458"><span class="linenos">458</span></a>            <span class="p">)</span>
</span><span id="Mineral.load-459"><a href="#Mineral.load-459"><span class="linenos">459</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mineral.load-460"><a href="#Mineral.load-460"><span class="linenos">460</span></a>        <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral.load-461"><a href="#Mineral.load-461"><span class="linenos">461</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;meta_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="Mineral.load-462"><a href="#Mineral.load-462"><span class="linenos">462</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fractions_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral.load-463"><a href="#Mineral.load-463"><span class="linenos">463</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;orientations_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral.load-464"><a href="#Mineral.load-464"><span class="linenos">464</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral.load-465"><a href="#Mineral.load-465"><span class="linenos">465</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span>
</span><span id="Mineral.load-466"><a href="#Mineral.load-466"><span class="linenos">466</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fractions&quot;</span><span class="p">])</span>
</span><span id="Mineral.load-467"><a href="#Mineral.load-467"><span class="linenos">467</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">])</span>
</span><span id="Mineral.load-468"><a href="#Mineral.load-468"><span class="linenos">468</span></a>
</span><span id="Mineral.load-469"><a href="#Mineral.load-469"><span class="linenos">469</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">phase</span> <span class="o">=</span> <span class="n">phase</span>
</span><span id="Mineral.load-470"><a href="#Mineral.load-470"><span class="linenos">470</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fabric</span> <span class="o">=</span> <span class="n">fabric</span>
</span><span id="Mineral.load-471"><a href="#Mineral.load-471"><span class="linenos">471</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">regime</span> <span class="o">=</span> <span class="n">regime</span>
</span><span id="Mineral.load-472"><a href="#Mineral.load-472"><span class="linenos">472</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">orientations_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Mineral.load-473"><a href="#Mineral.load-473"><span class="linenos">473</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">fractions_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Load CPO data from a <code>numpy</code> NPZ file.</p>

<p>If <code>postfix</code> is not <code>None</code>, data is read from fields ending with "<code>_postfix</code>".</p>

<p>See also: <code><a href="#Mineral.save">Mineral.save</a></code>, <code><a href="#Mineral.from_file">Mineral.from_file</a></code>.</p>
</div>


                            </div>
                            <div id="Mineral.from_file" class="classattr">
                                        <input id="Mineral.from_file-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_file</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">filename</span>, </span><span class="param"><span class="n">postfix</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Mineral.from_file-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Mineral.from_file"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Mineral.from_file-475"><a href="#Mineral.from_file-475"><span class="linenos">475</span></a>    <span class="nd">@classmethod</span>
</span><span id="Mineral.from_file-476"><a href="#Mineral.from_file-476"><span class="linenos">476</span></a>    <span class="k">def</span> <span class="nf">from_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">postfix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="Mineral.from_file-477"><a href="#Mineral.from_file-477"><span class="linenos">477</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct a `Mineral` instance using data from a `numpy` NPZ file.</span>
</span><span id="Mineral.from_file-478"><a href="#Mineral.from_file-478"><span class="linenos">478</span></a>
</span><span id="Mineral.from_file-479"><a href="#Mineral.from_file-479"><span class="linenos">479</span></a><span class="sd">        If `postfix` is not `None`, data is read from fields ending with `_postfix`.</span>
</span><span id="Mineral.from_file-480"><a href="#Mineral.from_file-480"><span class="linenos">480</span></a>
</span><span id="Mineral.from_file-481"><a href="#Mineral.from_file-481"><span class="linenos">481</span></a><span class="sd">        See also: `Mineral.save`, `Mineral.load`.</span>
</span><span id="Mineral.from_file-482"><a href="#Mineral.from_file-482"><span class="linenos">482</span></a>
</span><span id="Mineral.from_file-483"><a href="#Mineral.from_file-483"><span class="linenos">483</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Mineral.from_file-484"><a href="#Mineral.from_file-484"><span class="linenos">484</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.npz&quot;</span><span class="p">):</span>
</span><span id="Mineral.from_file-485"><a href="#Mineral.from_file-485"><span class="linenos">485</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="Mineral.from_file-486"><a href="#Mineral.from_file-486"><span class="linenos">486</span></a>                <span class="sa">f</span><span class="s2">&quot;Must only load from numpy NPZ format. Cannot load from </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">.&quot;</span>
</span><span id="Mineral.from_file-487"><a href="#Mineral.from_file-487"><span class="linenos">487</span></a>            <span class="p">)</span>
</span><span id="Mineral.from_file-488"><a href="#Mineral.from_file-488"><span class="linenos">488</span></a>        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span><span id="Mineral.from_file-489"><a href="#Mineral.from_file-489"><span class="linenos">489</span></a>        <span class="k">if</span> <span class="n">postfix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Mineral.from_file-490"><a href="#Mineral.from_file-490"><span class="linenos">490</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;meta_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
</span><span id="Mineral.from_file-491"><a href="#Mineral.from_file-491"><span class="linenos">491</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;fractions_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral.from_file-492"><a href="#Mineral.from_file-492"><span class="linenos">492</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;orientations_</span><span class="si">{</span><span class="n">postfix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
</span><span id="Mineral.from_file-493"><a href="#Mineral.from_file-493"><span class="linenos">493</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Mineral.from_file-494"><a href="#Mineral.from_file-494"><span class="linenos">494</span></a>            <span class="n">phase</span><span class="p">,</span> <span class="n">fabric</span><span class="p">,</span> <span class="n">regime</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span>
</span><span id="Mineral.from_file-495"><a href="#Mineral.from_file-495"><span class="linenos">495</span></a>            <span class="n">fractions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;fractions&quot;</span><span class="p">])</span>
</span><span id="Mineral.from_file-496"><a href="#Mineral.from_file-496"><span class="linenos">496</span></a>            <span class="n">orientations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;orientations&quot;</span><span class="p">])</span>
</span><span id="Mineral.from_file-497"><a href="#Mineral.from_file-497"><span class="linenos">497</span></a>
</span><span id="Mineral.from_file-498"><a href="#Mineral.from_file-498"><span class="linenos">498</span></a>        <span class="n">mineral</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Mineral.from_file-499"><a href="#Mineral.from_file-499"><span class="linenos">499</span></a>            <span class="n">phase</span><span class="p">,</span>
</span><span id="Mineral.from_file-500"><a href="#Mineral.from_file-500"><span class="linenos">500</span></a>            <span class="n">fabric</span><span class="p">,</span>
</span><span id="Mineral.from_file-501"><a href="#Mineral.from_file-501"><span class="linenos">501</span></a>            <span class="n">regime</span><span class="p">,</span>
</span><span id="Mineral.from_file-502"><a href="#Mineral.from_file-502"><span class="linenos">502</span></a>            <span class="n">n_grains</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
</span><span id="Mineral.from_file-503"><a href="#Mineral.from_file-503"><span class="linenos">503</span></a>            <span class="n">fractions_init</span><span class="o">=</span><span class="n">fractions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Mineral.from_file-504"><a href="#Mineral.from_file-504"><span class="linenos">504</span></a>            <span class="n">orientations_init</span><span class="o">=</span><span class="n">orientations</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="Mineral.from_file-505"><a href="#Mineral.from_file-505"><span class="linenos">505</span></a>        <span class="p">)</span>
</span><span id="Mineral.from_file-506"><a href="#Mineral.from_file-506"><span class="linenos">506</span></a>        <span class="n">mineral</span><span class="o">.</span><span class="n">fractions</span> <span class="o">=</span> <span class="n">fractions</span>
</span><span id="Mineral.from_file-507"><a href="#Mineral.from_file-507"><span class="linenos">507</span></a>        <span class="n">mineral</span><span class="o">.</span><span class="n">orientations</span> <span class="o">=</span> <span class="n">orientations</span>
</span><span id="Mineral.from_file-508"><a href="#Mineral.from_file-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="n">mineral</span>
</span></pre></div>


            <div class="docstring"><p>Construct a <code><a href="#Mineral">Mineral</a></code> instance using data from a <code>numpy</code> NPZ file.</p>

<p>If <code>postfix</code> is not <code>None</code>, data is read from fields ending with <code>_postfix</code>.</p>

<p>See also: <code><a href="#Mineral.save">Mineral.save</a></code>, <code><a href="#Mineral.load">Mineral.load</a></code>.</p>
</div>


                            </div>
                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>